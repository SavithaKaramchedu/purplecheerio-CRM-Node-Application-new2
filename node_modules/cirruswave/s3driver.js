var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(c){var l=function(){};l.prototype=c;return new l};$jscomp.underscoreProtoCanBeSet=function(){var c={a:!0},l={};try{return l.__proto__=c,l.a}catch(k){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(c,l){c.__proto__=l;if(c.__proto__!==l)throw new TypeError(c+" is not extensible");return c}:null;
$jscomp.inherits=function(c,l){c.prototype=$jscomp.objectCreate(l.prototype);c.prototype.constructor=c;if($jscomp.setPrototypeOf){var k=$jscomp.setPrototypeOf;k(c,l)}else for(k in l)if("prototype"!=k)if(Object.defineProperties){var g=Object.getOwnPropertyDescriptor(l,k);g&&Object.defineProperty(c,k,g)}else c[k]=l[k];c.superClass_=l.prototype};$jscomp.owns=function(c,l){return Object.prototype.hasOwnProperty.call(c,l)};
$jscomp.assign="function"==typeof Object.assign?Object.assign:function(c,l){for(var k=1;k<arguments.length;k++){var g=arguments[k];if(g)for(var r in g)$jscomp.owns(g,r)&&(c[r]=g[r])}return c};$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,l,k){c!=Array.prototype&&c!=Object.prototype&&(c[l]=k.value)};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};
$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(c,l,k,g){if(l){k=$jscomp.global;c=c.split(".");for(g=0;g<c.length-1;g++){var r=c[g];r in k||(k[r]={});k=k[r]}c=c[c.length-1];g=k[c];l=l(g);l!=g&&null!=l&&$jscomp.defineProperty(k,c,{configurable:!0,writable:!0,value:l})}};$jscomp.polyfill("Object.assign",function(c){return c||$jscomp.assign},"es6","es3");
(function(){function c(c,a){r[c]||(g[c]={exports:{},loaded:!1},r[c]=!0,0===c&&"function"===typeof require?require.main=g[0]:g[c].parent=g[a],k[c].call(this,g[c],g[c].exports),g[c].loaded=!0);return g[c].exports}function l(c){return require("path").resolve(__dirname+"/"+c+"/../")}var k={},g={},r={};k[0]=function(l,a){var x=c(1,0),k=require("aws-sdk"),g=c(2,0);a=function(a){var h=g.call(this)||this;h.bucketName=a.bucketName;h.encseckey=a.encseckey;k.config.region=a.region;k.config.update({accessKeyId:a.acckey,
secretAccessKey:a.secretkey});return h};$jscomp.inherits(a,g);a.prototype.Delete=function(a,h,c){(new k.S3({params:{Bucket:this.bucketName+"/"+h}})).deleteObject({Key:a},function(h,m){if(h)return console.log("Error in posting Content ["+h+"]"),!1;console.log("Successfully Deleted Key = "+a);c&&c(null,"OK")}).on("httpUploadProgress",function(a){console.log(Math.round(a.loaded/a.total*100)+"% done")})};a.prototype.Get=function(a,h,c){var m=this;(new k.S3({params:{Bucket:this.bucketName+"/"+h}})).getObject({Key:a},
function(a,h){if(a)return a="Error in getting Content ["+a+"]",console.log(a),c&&c(a,null),!1;a=h.Body.toString();m.encseckey&&(a=x.Decipher(m.encseckey,a),a=a.toString("UTF8"));console.log("Successfully Get Key = "+a);c&&c(null,JSON.parse(a))}).on("httpUploadProgress",function(a){console.log(Math.round(a.loaded/a.total*100)+"% done")})};a.prototype.ListRecursive=function(a,h,c){var m=new k.S3({params:{Bucket:this.bucketName+"/"+a}});h={Bucket:this.bucketName,MaxKeys:100,ContinuationToken:h};null===
a?h.Delimiter="/":h.Prefix="*"!=a?a:"";m.listObjectsV2(h,function(h,m){if(h)return strErr="Error in listing Contents ["+h+"]",console.log(strErr),c&&c(strErr,null),!1;c&&c(null,m);m.NextContinuationToken&&(console.log("continue="+m.NextContinuationToken),this.ListRecursive(a,m.NextContinuationToken))}).on("httpUploadProgress",function(a){console.log(Math.round(a.loaded/a.total*100)+"% done")})};a.prototype.Listirectories=function(a){this.ListRecursive(null,null,a)};a.prototype.ListObjects=function(a,
c){this.ListRecursive(a,null,c)};a.prototype.Put=function(a,c,m,l){m=new k.S3({params:{Bucket:this.bucketName+"/"+m}});var h=JSON.stringify(c);this.encseckey&&(h=x.Cipher(this.encseckey,h));m.putObject({Key:a,Body:h,ContentType:"text/plain; charset=utf-8"},function(a,h){if(a)return a="Error in posting Content ["+a+"]",console.log(a),l&&l(a,null),!1;console.log("Successfully posted Content");l&&l(null,c)}).on("httpUploadProgress",function(a){console.log(Math.round(a.loaded/a.total*100)+"% done")})};
l.exports=a;return l.exports};k[1]=function(k,a){function x(b,e){b=u.createHmac("sha256",b);b.update(e);return b.digest("hex")}function g(b,e){var d=c(3,1);if(b.secret&&b.acckey){if("accesskey"===b.security){var a=new Date,p=b.acckey+":"+b.nonce;e.Authorization="hmac "+p+":"+d.Sign(b.secret,p+":"+a);e.Date=a;return}if("basic"===b.security){d=Buffer.from(b.acckey+":"+b.secret).toString("base64");e.Authorization="basic "+d;return}}b.Authorization?(e.Authorization=b.Authorization,d=e.Authorization.indexOf("hmac "),
0!=d?(d=e.Authorization.search(/basic /i),0!==d&&console.log("badly formed authorization string - needs to start with hmac")):(d=e.Authorization.slice(d+5),d.split(":"),e.Date=b.Date)):console.log("missing authorization string")}function r(b){if(!b)return null;var e="",d;for(d in b)"object"===typeof b[d]?(""!=e&&(e+="&"),e+=d+"="+JSON.stringify(b[d])):"array"!==typeof b[d]&&(""!=e&&(e+="&"),e+=d+"="+b[d]);return e}var t=require("http"),h=require("https"),m=require("fs"),A=require("path"),G=require("querystring"),
u=require("crypto"),F=require("jsonschema").Validator;a.Cipher=function(b,e){var d=u.randomBytes(16).toString("hex").slice(0,16),a=u.createHash("sha256").update(b).digest("hex");a=a.slice(0,32);e=u.createCipheriv("aes-256-ctr",a,d).update(e).toString("hex");b=x(b,e);return d+":::"+e+":::"+b};a.Decipher=function(b,e){var d=e.split(":::");e=d[0];var a=d[2],p=x(b,d[1]);if(a!=p)return null;d=new Buffer(d[1],"hex");b=u.createHash("sha256").update(b).digest("hex");b=b.slice(0,32);return u.createDecipheriv("aes-256-ctr",
b,e).update(d)};a.ValidateSchemaErrorObject=function(b,e){b=(new F).validate(b,e);if(b.errors.length){e="";for(var d in b.errors)e+=b.errors[d].stack+" ";return e}return null};a.ValidateSchema=function(b,e,d,a){return(b=this.ValidateSchemaErrorObject(b,e))?(a.status(422).json({errors:b}),!1):!0};a.BodyValidate=function(b,e,d,a){return d&&d.bodyschema?(a&&(d.bodyschema.definitions=d.bodyschema.definitions?Object.assign(d.bodyschema.definitions,a):a),this.ValidateSchema(b.body,d.bodyschema,b,e)):!0};
a.ParamValidate=function(b,e,d,a){if(d&&d.paramschema){var p=b.params[0],f=d.route;"/"==f.slice(0,1)&&(f=f.slice(1));"/"==p.slice(0,1)&&(p=p.slice(1));"/"==f.slice(-1)&&(f=f.slice(0,-1));"/"==p.slice(-1)&&(p=p.slice(0,-1));for(var n={};""!=f;){var q=!1;":"==f.slice(0,1)&&(q=!0,f=f.slice(1));var c=f.search("/"),h=p.search("/");if(0<=c){var y=f.slice(0,c);f=f.slice(c+1);var m=p.slice(0,h);p=p.slice(h+1)}else y=f.slice(0),f="",m=p.slice(0),p="";q&&(q=Number(m),isNaN(q)?n[y]=m:n[y]=q)}a&&(d.paramschema.definitions=
d.paramschema.definitions?Object.assign(d.paramschema.definitions,a):a);a=b.query;for(c in a)isNaN(a[c])||(a[c]=Number(a[c]));n=Object.assign({},n,a);return this.ValidateSchema(n,d.paramschema,b,e)}return!0};a.deep_value=function(b,e){e=e.split(".");for(var d in e)b=b[e[d]];return b};var B=require("os");a.GetIPFromService=function(b){var e=B.networkInterfaces(),d=null;b.networkname&&(d=b.networkname);b=null;for(var a in e){for(var p in e[a]){var f=e[a][p];"IPv4"!==f.family||f.internal||(b=f.address)}if(a==
d)break}return b};a.getFunctionsOfObject=function(b){return Object.getOwnPropertyNames(b).filter(function(e){return"function"==typeof b[e]})};a.MakeDir=function(b){var e=require("child_process").exec;e("mkdir  "+b)};a.WriteFile=function(b,e){try{return m.writeFileSync(b,e,"utf8"),!0}catch(d){return!1}};a.FormatYYYYMMDD=function(b){return b.getUTCFullYear()+"-"+("0"+(b.getUTCMonth()+1)).slice(-2)+"-"+("0"+b.getUTCDate()).slice(-2)};a.FormatYYYYMMDDHHMMSS=function(b){return this.FormatYYYYMMDD(b)+"-"+
("0"+b.getUTCHours()).slice(-2)+"-"+("0"+b.getUTCMinutes()).slice(-2)+"-"+("0"+b.getUTCSeconds()).slice(-2)};a.FormatYYYYMMDDHHMMSSColon=function(b){return this.FormatYYYYMMDD(b)+"T"+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+":"+("0"+b.getUTCSeconds()).slice(-2)};a.Median=function(b){b.sort(function(b,e){return b-e});var e=b.length,d=Math.floor(e/2),a;1===e%2?a=b[d]:a=(b[d-1]+b[d])/2;return a};a.LowPassFilter=function(b,e,d){if(.1<Math.abs(e)){var a=(e-b)/b;a>d?e=b*(1+
d):a<d&&(e=b*(1-d))}return e};a.PostPutHttp=function(b,e,a,c,p,f,n,q,v,m){var d={"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":q.length};a&&(d[a.keyName]=a.keyValue);if(e&&"object"===typeof e){if("accesskey"===e.security||"basic"===e.security)g(e,d),e=null;e=null}b={hostname:p,port:n,path:f,method:b,headers:d,json:!0};e&&(b.auth=e);e=t;if("https"==c||"https:"==c)b.rejectUnauthorized=!1,e=h;c=e.request(b,function(b){var a="";b.setEncoding("utf8");
b.on("data",function(b){a+=b});b.on("end",function(){200!=b.statusCode&&(console.log("Error statusCode="+b.statusCode),a&&console.log("data="+JSON.stringify(a)));v&&v(m,b.statusCode,a)})});c.on("error",function(b){console.log("problem with request: "+b.message);v&&v(m,500,b)});c.write(q);c.end()};a.PostHttpAuth=function(b,a,d,c,p,f,n,q,h){this.PostPutHttp("POST",b,a,d,c,p,f,n,q,h)};a.PostHttp=function(b,a,d,c,p,f,n,q){this.PostPutHttp("POST",null,b,a,d,c,p,f,n,q)};a.PutHttp=function(b,a,d,c,p,f,n,
q){this.PostPutHttp("PUT",null,b,a,d,c,p,f,n,q)};a.GetHttpAuth=function(b,a,d,c,p){b=t.request({hostname:b,port:d,path:a+"/"+c,method:"GET",headers:{"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":c.length},json:!0},function(b){var a="";b.setEncoding("utf8");b.on("data",function(b){a+=b});b.on("end",function(){200!=b.statusCode&&console.log("Error statusCode="+b.statusCode);p(b.statusCode,a)})});b.on("error",function(b){console.log("problem with request: "+
b.message)});b.end()};a.GetDeleteHttp=function(b,a,d,c,p,f,n,q,v,m){var e={"User-Agent":"app-bt/0.0.1","Cache-Control":"no-cache"};d&&(e[d.keyName]=d.keyValue);if(a&&"object"===typeof a){if("accesskey"===a.security||"basic"===a.security)g(a,e),a=null;a=null}q&&(q=G.escape(q),f=f+"/?"+q);b={hostname:p,port:n,path:f,method:b,headers:e,json:!0};a&&(b.auth=a);a=t;if("https"==c||"https:"==c)b.rejectUnauthorized=!1,a=h;c=a.request(b,function(b){var a="";b.setEncoding("utf8");b.on("data",function(b){a+=
b});b.on("end",function(){200!=b.statusCode&&console.log("Error statusCode="+b.statusCode);v(m,b.statusCode,a)})});c.on("error",function(b){console.log("problem with request: "+b.message)});c.end()};a.GetHttpProper=function(b,a,d,c,p,f,n,q,h){this.GetDeleteHttp("GET",b,a,d,c,p,f,n,q,h)};a.DeleteHttp=function(b,a,d,c,p,f,n,q,h){this.GetDeleteHttp("DELETE",b,a,d,c,p,f,n,q,h)};var H=0,I=require("url");try{var C=A.resolve(l("cirruswaveutil.js"),"./lib/deploy.json"),w=m.readFileSync(C,"UTF8"),D=JSON.parse(w)}catch(b){"ENOENT"!=
b.code&&console.log(b.code+" - "+b.message)}a.RestTaskCall=function(b,a,d){var e=!1,c={};b.payload&&console.log("\t\tpayload ="+JSON.stringify(b.payload));var f=null;if(b.service&&b.servicepath){if(b.sysservice){if(!b.serviceconfig){c="Parameter error: Task="+b.name+" does not contain serviceconfig";console.error(c);a(d,404,JSON.stringify(c));return}var n=this.GetServiceConfig(b.serviceconfig,b.service)}else{if(!b.appserviceconfig){c="Parameter error: Task="+b.name+" does not contain appserviceconfig";
console.error(c);a(d,404,JSON.stringify(c));return}n=this.GetServiceConfig(b.appserviceconfig,b.service);if(!n){if(!b.serviceconfig){c="Parameter error: Task="+b.name+" does not contain serviceconfig";console.error(c);a(d,404,JSON.stringify(c));return}n=this.GetServiceConfig(b.serviceconfig,b.service)}}if(!(n&&"object"==typeof n&&n.hasOwnProperty("protocol")&&n.hasOwnProperty("hostname")&&n.hasOwnProperty("port"))){c="Parameter error: Task="+b.name+" has unrecognized service="+b.service+" sc="+JSON.stringify(n);
console.error(c);a(d,404,JSON.stringify(c));return}D&&D.dnsservicename&&"localhost"==n.hostname&&(n.hostname=b.service);e=!0;c.protocol=n.protocol;c.hostname=n.hostname;c.port=n.port;switch(n.security){case "basic":case "accesskey":f={};f.security=n.security;f.nonce=H++;f.acckey=b.acckey;f.secret=b.secretna;break;case "appkey":c.key=b.appkey?this.MakeKeyServiceAndKeyValue(b.service,b.appkey):this.MakeKeyServiceAndKeyValue(b.service,n.key)}c.pathname=b.servicepath;0!=c.pathname.search("/")&&(c.pathname=
"/"+c.pathname)}if(b.url||e)switch(e=null,b.payload&&(e=b.payload),b.url&&(c=I.parse(b.url),c.key=null),b.method){case "POST":b="";e&&(b=JSON.stringify(e));this.PostPutHttp("POST",f,c.key,c.protocol,c.hostname,c.pathname,c.port,b,a,d);break;case "PUT":b="";e&&(b=JSON.stringify(e));this.PostPutHttp("PUT",f,c.key,c.protocol,c.hostname,c.pathname,c.port,b,a,d);break;case "GET":b="";e&&(b=r(e));this.GetHttpProper(f,c.key,c.protocol,c.hostname,c.pathname,c.port,b,a,d);break;case "DELETE":b="";e&&(b=r(e));
this.DeleteHttp(f,c.key,c.protocol,c.hostname,c.pathname,c.port,b,a,d);break;default:c=b.hasOwnProperty("name")?"Parameter error: Task="+b.name+" has unrecognized method="+b.method:"Parameter error: unrecognized method="+b.method,console.error(c),a(d,404,{error:c})}else b.func?(b.payload&&JSON.parse(JSON.stringify(b.payload)),c=eval("this.to."+b.func+"(payload)"),a(d,200,c)):a(d,200,{})};a.ServiceKeyName=function(b){return b+"-api-key"};a.MakeKeyServiceAndKeyValue=function(b,a){if(!a)return null;
var c={};c.keyName=this.ServiceKeyName(b);c.keyValue=a;return c};a.EstablishKey=function(b,a){var c=m.readFileSync(b,"utf8");c=JSON.parse(c);var e=c.services;if(!e||!e[a]||"appkey"!==e[a].security)return null;e[a].key||(e[a].key=this.GenerateKeyFromDate((new Date).toString()),m.writeFileSync(b,JSON.stringify(c,0,2),"UTF8"));return e[a].key};a.GenerateKeyFromDate=function(b){return u.createHash("md5").update(b).digest("hex")};a.GetServiceConfig=function(b,a){var c=m.readFileSync(b,"utf8");c=JSON.parse(c);
if(!c)return null;var e=c.services;if(!e||!e[a])return null;c=e[a];e[a].security||(e[a].security="nokey",m.writeFileSync(b,JSON.stringify(c,0,2),"UTF8"));return e[a]};a.PriorityQueue=function(b){this._comparator=b||this.DEFAULT_COMPARATOR;this._elements=[];this.DEFAULT_COMPARATOR=function(b,a){if("number"===typeof b&&"number"===typeof a)return b-a;b=b.toString();a=a.toString();return b==a?0:b>a?1:-1};a.PriorityQueue.isEmpty=function(){return 0===this.size()};this.peek=function(){if(this.isEmpty())throw Error("PriorityQueue is empty");
return this._elements[0]};this.deq=function(){return this._elements.length?this._elements.shift():null};this.enq=function(b){b=this._elements.push(b);for(var a=b-1;0<a;){var c=a-1;if(0>=this._compare(a,c))break;this._swap(c,a);a=c}return b};this.size=function(){return this._elements.length};this.getElement=function(b){return 0>b||b>=this.size()?null:this._elements[b]};this.getElements=function(b){return this._elements};this.forEach=function(b){return this._elements.forEach(b)};this._compare=function(b,
a){return this._comparator(this._elements[b],this._elements[a])};this._swap=function(b,a){var c=this._elements[b];this._elements[b]=this._elements[a];this._elements[a]=c}};var z=require("cacheman");a.TtlCache=function(b,a,c){if(!b)return null;if(a||c){var d={};a&&(d.ttl=a);c&&(d.engine=c);this.cache=new z(b,d)}else this.cache=new z(b);this.Set=function(b,a,c){this.cache.set(b,a,c)};this.Get=function(b,a){this.cache.get(b,a)}};var E=require("dgram");a.Udp=function(b,a,c,h){this.server=E.createSocket("udp4");
b||a?(this.server.bind({address:c,port:h}),this.server.on("listen",b),this.server.on("message",a),this.broadcastMode=!1):this.broadcastMode=!0;this.address=function(){return this.server.address().address};this.port=function(){return this.server.address().port};this.broadcast=function(b,a,c){if(this.broadcastMode){var f=new Buffer(JSON.stringify(c));this.server.send(f,0,f.length,a,b,function(){console.log("Sent '"+f+"'")})}}};return k.exports};k[2]=function(c,a){c.exports=function(){"storagedriver"===
this.constructor.name&&(console.error("can not instantiate storage driver"),process.exit(1));var a=[];void 0===this.Get&&a.push("Get");void 0===this.Delete&&a.push("Delete");void 0===this.Listirectories&&a.push("Listirectories");void 0===this.ListObjects&&a.push("ListObjects");void 0===this.Put&&a.push("Put");a.length&&(console.error(a+" required on "+this.constructor.name+" class"),process.exit(1))};return c.exports};k[3]=function(k,a){function g(b,a){return{status:b,message:a}}function r(b,a){d.storage.Get(b,
d.folderkeys,function(c,f){c?a(g(404,"acckey="+b+" "+c),null):a(null,f)})}function J(b,a){r(b,function(b,c){b?a(b,null):(b=JSON.parse(JSON.stringify(c)),delete b.secret,a(null,b))})}function t(b,a){d.storage.Get(b,d.folderids,function(c,f){c?a(g(404,"client="+b+" "+c),null):a(null,f)})}function h(b,a,c){d.storage.Put(b,a,d.folderids,function(f,e){f?c(g(404,f),null):"file"===d.type?c(null,e):d.storage.Put(a.acckey,a,d.folderkeys,function(a,f){a&&A(b,!1,function(b,c){b?c(g(404,b),null):c(g(404,a),null)});
c(null,f)})})}function m(b,a,c,d,e){t(b,function(f,n){var q={services:[]};f||(q=n);q.acckey=a;q.secret=c;q.clientid=b;for(var m in d)0>q.services.indexOf(d[m])&&q.services.push(d[m]);h(b,q,e)})}function A(b,a,c){t(b,function(f,e){d.storage.Delete(b,d.folderids,function(b,f){b?c(b,null):"file"!==d.type&&a?d.storage.Delete(e.acckey,d.folderkeys,function(b,a){b?c(b,null):c(null,"OK")}):c(null,"OK")})})}function G(b,a){if(b=b.authorization)if(0!=b.search(/basic /i))a(g(403,"basic authorization header needs to start with basic"),
null);else{b=b.slice(6);var c=Buffer.from(b,"base64").toString().split(":"),d=c[0];r(d,function(b,f){b?a(g(403,"acckey="+d+" not found"),null):c[1]===f.secret?a(null,f):a(g(403,"could not authenticate"),null)})}else a(g("403","Authorization header missing"),null)}function u(b,a){var c=b.authorization;if(c)if(0!=c.search(/hmac /i))G(b,a);else{var d=c.slice(5).split(":"),e=d[0];r(e,function(c,f){if(c)a(g(403,"acckey="+e+" not found"),null);else{var n=b.date,h=d.splice(-1,1)[0];c=d.join(":");C(f.secret,
c+(":"+n))==h?a(null,f):a(g(403,"could not authenticate"),null)}})}else a(g(403,"Authorization header missing"),null)}function F(b,a,c){var d=(new Date).valueOf(),e=Math.round(Math.random()*d),f=w.GenerateKeyFromDate(e.toString());e=Math.round(Math.random()*d);d=w.GenerateKeyFromDate(e.toString());m(b,f,d,a,c)}function B(b){var a=w.GetServiceConfig(z,b);return a?a:a=w.GetServiceConfig(E,b)}function H(b,a,c){r(b,function(b,d){b?c(b,null):(b=B(a))?"accesskey"!==b.security&&"basic"!==b.security?c(g(403,
"access is forbidden to service="+a),null):(a&&0>d.services.indexOf(a)&&d.services.push(a),h(d.clientid,d,c)):c(g(404,"No such service="+a),null)})}function I(b,a,c){r(b,function(b,d){b=B(a);"accesskey"!==b.security&&"basic"!==b.security?c(g(403,"access is forbidden"),null):(b=d.services.indexOf(a),0>b?c(g(403,"no access to service="+a),null):(d.services.splice(b,1),h(d.clientid,d,c)))})}function C(b,a){b=D.createHmac("sha256",b);b.update(a);return b.digest("hex")}var w=c(1,3),D=require("crypto"),
z=l("apikeymgr.js")+"/deploy/lib/serviceconfig.json",E=z,b=l("apikeymgr.js");require("fs");var e=require("path"),d=null,y=c(0,3),p=c(4,3);a.initialize=function(a){var c="./deploy/lib/aclconfig.json";if(a)switch(b=a.appdir,c=a.aclconfig,E=e.resolve(b,a.appserviceconfig),d={type:"file"},a.persistence&&(d=a.persistence),d.folderkeys="pc-keyfolder/keys",d.folderids="pc-keyfolder/ids",d.type){case "file":d.storage=new p(a);break;case "s3":d.storage=new y({encseckey:a.secret,bucketName:d.bucketname,acckey:d.acckey,
secretkey:d.secret,region:d.region})}a.aclconfpath=e.resolve(b,c)};a.Sign=function(b,a){return C(b,a)};a.RouteAllocateAccessKeys=function(b,a){F(b.params.clientid,[],function(b,c){b?a.status(b.status).json(b.message):a.status(200).json(c)})};a.RouteGetClientFromClientid=function(b,a){t(b.params.clientid,function(b,c){b?a.status(b.status).json(b.message):a.status(200).json(c)})};a.RouteGetClientFromAcckey=function(b,a){r(b.params.acckey,function(b,c){b?a.status(b.status).json(b.message):a.status(200).json(c)})};
a.RouteRevokeClient=function(b,a){A(b.params.clientid,!0,function(b,c){b?a.status(b.status).json(b.message):a.status(200).json({data:"OK"})})};a.RouteGrantAccess=function(b,a){H(b.params.acckey,b.params.servicename,function(b,c){b?a.status(b.status).json(b.message):a.status(200).json(c)})};a.RouteRevokeAccess=function(b,a){I(b.params.acckey,b.params.servicename,function(b,c){b?a.status(b.status).json(b.message):a.status(200).json(c)})};a.RouteGetAccessServices=function(b,a){J(b.params.acckey,function(b,
c){b?a.status(b.status).json(b.message):a.status(200).json(c.services)})};a.RouteGetAccessOneService=function(b,a){J(b.params.acckey,function(c,d){c?a.status(c.status).json(c.message):0>d.services.indexOf(b.params.servicename)?a.status(404).json("access was never granted to client="+d.clientid+" for service="+servicename):a.status(200).json(b.params.servicename)})};a.RouteCheckAccessOneService=function(b,a){b.body.headers?u(b.body.headers,function(c,d){c?a.status(c.status).json(c.message):0>d.services.indexOf(b.body.servicename)?
a.status(404).json("access was never granted to client="+o.clientid+" for service="+servicename):a.status(200).json({servicename:b.body.servicename})}):a.status(400).json("headers missing in the body of request")};return k.exports};k[4]=function(g,a){var k=c(1,4),l=c(2,4),r=require("fs"),t=require("path");a=function(a){var c=l.call(this)||this;c.aclpath=a.aclconfpath;c.encseckey=a.secret;c.appdir=a.appdir;console.log(c.appdir);console.log(a.aclconfig);c.aclpath=t.resolve(c.appdir,a.aclconfig);c.acl=
null;r.existsSync(c.aclpath)&&(c.acl=c.ReadAclFromFile(c.aclpath));c.acl||(c.acl={},c.WriteAclToFile(c.aclpath));return c};$jscomp.inherits(a,l);a.prototype.CreateSignature=function(a){return crypto.createHash("sha256").update(a).digest("hex")};a.prototype.WriteAclToFile=function(a){a=JSON.stringify(this.acl);a=k.Cipher(this.encseckey,a);r.writeFileSync(this.aclpath,a)};a.prototype.ReadAclFromFile=function(a){a=r.readFileSync(this.aclpath,"utf8");a=k.Decipher(this.encseckey,a);if(!a)return null;a=
a.toString("UTF8");return JSON.parse(a)};a.prototype.Delete=function(a,c,g){var h=-1;if("pc-keyfolder/keys"===c){for(var m in this.acl)this.acl[m].acckey==a&&(h=m);if(-1===h){g("key "+a+" not found",null);return}}else h=a;delete this.acl[h];g&&g(null,"OK")};a.prototype.Listirectories=function(){};a.prototype.ListObjects=function(a){};a.prototype.Get=function(a,c,g){if("pc-keyfolder/keys"===c){for(var h in this.acl){var m=this.acl[h];if(m.acckey==a){m.clientid=h;g(null,m);return}}console.log("name="+
a+" folder="+c);g("key "+a+" not found",null)}else this.acl[a]?(this.acl[a].clientid=a,g(null,this.acl[a])):(console.log("name="+a+" folder="+c),g("client "+a+" does not exist",null))};a.prototype.Put=function(a,c,g,k){this.acl[a]||(this.acl[a]={services:[]});this.acl[a].acckey=c.acckey;this.acl[a].secret=c.secret;for(var h in c.services)0>this.acl[a].services.indexOf(c.services[h])&&this.acl[a].services.push(c.services[h]);this.WriteAclToFile(this.aclpath);k(null,this.acl[a])};g.exports=a;return g.exports};
if("object"===typeof module)module.exports=c(0);else return c(0)})();
