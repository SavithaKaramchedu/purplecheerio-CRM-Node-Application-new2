var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(n){var g=function(){};g.prototype=n;return new g};$jscomp.underscoreProtoCanBeSet=function(){var n={a:!0},g={};try{return g.__proto__=n,g.a}catch(r){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(n,g){n.__proto__=g;if(n.__proto__!==g)throw new TypeError(n+" is not extensible");return n}:null;
$jscomp.inherits=function(n,g){n.prototype=$jscomp.objectCreate(g.prototype);n.prototype.constructor=n;if($jscomp.setPrototypeOf){var r=$jscomp.setPrototypeOf;r(n,g)}else for(r in g)if("prototype"!=r)if(Object.defineProperties){var t=Object.getOwnPropertyDescriptor(g,r);t&&Object.defineProperty(n,r,t)}else n[r]=g[r];n.superClass_=g.prototype};$jscomp.owns=function(n,g){return Object.prototype.hasOwnProperty.call(n,g)};
$jscomp.assign="function"==typeof Object.assign?Object.assign:function(n,g){for(var r=1;r<arguments.length;r++){var t=arguments[r];if(t)for(var x in t)$jscomp.owns(t,x)&&(n[x]=t[x])}return n};$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(n,g,r){n!=Array.prototype&&n!=Object.prototype&&(n[g]=r.value)};$jscomp.getGlobal=function(n){return"undefined"!=typeof window&&window===n?n:"undefined"!=typeof global&&null!=global?global:n};
$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(n,g,r,t){if(g){r=$jscomp.global;n=n.split(".");for(t=0;t<n.length-1;t++){var x=n[t];x in r||(r[x]={});r=r[x]}n=n[n.length-1];t=r[n];g=g(t);g!=t&&null!=g&&$jscomp.defineProperty(r,n,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Object.assign",function(n){return n||$jscomp.assign},"es6","es3");
(function(){function n(g,e){x[g]||(t[g]={exports:{},loaded:!1},x[g]=!0,0===g&&"function"===typeof require?require.main=t[0]:t[g].parent=t[e],r[g].call(this,t[g],t[g].exports),t[g].loaded=!0);return t[g].exports}function g(g){return require("path").resolve(__dirname+"/"+g+"/../")}var r={},t={},x={};r[0]=function(r,e){function v(a,b,c){c=c.toLowerCase();var l=[];try{l=a.routes.filter(function(a,d){d=a.route;if("static"===a.type)m=d;else{var m=d.replace(/\/:[a-z0-9A-Z.%\-_,;:()*?@'!]+/g,"/[a-z0-9A-Z.%\\-_,;:()*?@'!]+");
"*"==m?m=".*":("/"==b[b.length-1]&&"/"!=d[d.length-1]&&(m+="\\/"),"/"!=b[b.length-1]&&"/"==d[d.length-1]&&(b+="/"));m+="$"}if(0==b.search(new RegExp(m,"g"))&&(a.type.toLowerCase()==c||"static"==a.type.toLowerCase()&&"get"===c))throw l.push(a),l;})}catch(P){if("array"==typeof P)return P}return l[0]}function t(a,b,c){return a.routes.filter(function(a){return a.route==b&&a.type==c})[0]}function U(a,b,c){b&&(m=b);this.all("*",function(a,b,c){m.corsurl&&(b.header("Access-Control-Allow-Origin",m.corsurl),
b.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE,OPTIONS"),b.header("Access-Control-Allow-Credentials","true"),b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Key, Authorization"));b.header("X-Powered-By","cirruswave");c()});if(m.usecookies){var l=m.cookiesecret?h(m.cookiesecret):h();this.use(l)}this.use(d.json());this.use(d.urlencoded({extended:!0}));this.use(k.static(w.join(g("index.js"),"templates")));this.use("/service",k.static(w.join(g("index.js"),
"templates")));this.use("/samples",k.static(w.join(g("index.js"),"templates")));this.use("/dashboard",k.static(w.join(g("index.js"),"templates")));this.use("/css",k.static(w.join(g("index.js"),"templates")));this.use("/images",k.static(w.join(g("index.js"),"templates")));this.use("/css/bootstrap.css.map/",k.static(w.join(g("index.js"),"templates")));this.use("/documentation",function(a,b){B(a,b)});this.use("/test",function(a,b){D(a,b,!0,null,null)});this.use("/testhttp",function(a,b){D(a,b,!1,null,
null)});this.get("/routelist/:servicename",function(a,c){M(a,c,b)});this.use("/servicelist",function(a,c){K(a,c,b)});this.use("/editservices",function(a,b){a=z.readFileSync(g("index.js")+"/templates/services.html","utf8");var c="",l="",d=!1;m.services.hasOwnProperty("keymgr")&&(d=!0);if(!d){var h="";d||(h="System services can not be edited thorugh this interface but they can be viewed in documentation.  To see the list of services, please run the keymgr service. ");c+="<li><a class='scrollto' href='#about'>about</a></li>";
d="<pre>"+JSON.stringify(m.about,0,2)+"</pre>";var u=m.about?'about <a href="/editabout" title="edit \'about\' section" class="btn btn-link btn-sm"><span class="glyphicon glyphicon-pencil"></span></a>':'about <a href="/createabout" title="create \'about\' section" class="btn btn-link btn-sm"><span class="glyphicon glyphicon-plus"></span></a>';l+='<section id="REPLserviceid" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",
d).replace(/REPLservicename/g,u).replace(/REPLserviceid/g,"about");for(var f in m.services)d="",u=m.services[f],c+="<li><a class='scrollto' href='#"+f+"'>"+f+"</a></li>",d+="<pre>"+JSON.stringify(u,0,2)+"</pre>",u=f+' <a href="/editservice?service='+f+'" title="edit \''+f+'\' section" class="btn btn-link btn-sm">',u+='<span class="glyphicon glyphicon-pencil"></span></a>',l+='<section id="REPLserviceid" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",
d).replace(/REPLservicename/g,u).replace(/REPLserviceid/g,f);u='<a href="/createservice" title="create new service" class1="btn btn-link btn-sm"><span class="glyphicon glyphicon-plus"></span></a>';c+="<li>"+u+"</li>";l+='<section id="REPLserviceid" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent","").replace(/REPLservicename/g,u).replace(/REPLserviceid/g,"Create New Service");a=a.replace("REPLNotice",
h).replace("REPLservicelist",c).replace("REPLsectioncontent",l);a=C(a);b.send(a)}});this.use("/editabout",function(a,b){x(a,b,!1)});this.use("/editservice",function(a,b){x(a,b,!0)});this.get("/routeinfo/:servicename",function(a,c){N(a,c,b)});this.use("/service/:servicename",function(a,c){J(a.params.servicename,a,c,b)});this.use("/samples/:servicename",function(a,c){L(a.params.servicename,a,c,b)});this.use("/testhttpapi",function(a,b){a:{var c={},l={req:a,res:b,fService:!1};if(a.body.method){a.body.method=
a.body.method.toLowerCase();var d={security:"accesskey"};d.Authorization=a.body.auth;d.Date=a.body.date;switch(a.body.method){case "post":try{""!==a.body.payload&&(c=JSON.parse(a.body.payload))}catch(R){b.json({error:"payload is not proper json"});break a}p.PostPutHttp("POST",d,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),E,l);break;case "put":try{c=JSON.parse(a.body.payload)}catch(R){b.json({error:"payload is not proper json"});break a}p.PostPutHttp("PUT",null,
a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),E,l);break;case "get":p.GetHttpProper(d,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),E,l);break;case "delete":p.DeleteHttp(d,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),E,l)}}else b.send("error - method missing in the form")}});this.use("/testapi",function(a,c){"save"===a.body.action?c.json("Saved"):F(a,c,b,E,{req:a,res:c,fService:!0})});this.validatesecurekey(a,
b);this.get("/logoutbasic",function(b,c){switch(m.services[a].security){case "basic":c.status(401).send("Logged out");break;default:c.status(404).send("logoutbasic command available only when security is basic")}});this.get("/",function(a,b){B(a,b);next()});var u=this;this.get("/log/:level/:message",function(a,b){var c=p.ValidateSchemaErrorObject(a.params,{type:"object",required:["level","message"],properties:{level:{description:"level buckets",type:"string","enum":["info","trace","error","warn",
"debug"]},message:{description:"message text",type:"string",minLength:1,maxLength:2048}}});c?(u.LogObject("error",a,"schema error "+c,"Logger"),b.status(422).send(c)):(u.LogObject(a.params.level,a,a.params.message,"Logger"),b.status(200).send("OK"))});l=m.services[a];this.BodyValidate(a,l.configfilepath);if(l.init&&"object"==typeof l.init&&l.init.class&&l.init.function){var y=require(w.resolve(g("index.js"),l.init.class)),f=null;c&&(f=c);l.init.options&&!f&&(f=l.init.options);if(l.init.optionschema&&
(c=p.ValidateSchemaErrorObject(f,l.init.optionschema))){console.error("options do not conform to schema error="+c);return}y[l.init.function](f)}}function G(a,b){var c=g("index.js");H&&(c=H);var d=require(w.resolve(c,b)),l=this;this.post("/*",function(b,c,m){l.LogObject("event",b,"Entering",a);var h=v(d,b.path,b.method);h?p.ParamValidate(b,c,h,d.definitions)&&p.BodyValidate(b,c,h,d.definitions)&&m():c.status(422).json({errors:"path="+b.path+" not found"})});this.put("/*",function(b,c,m){l.LogObject("event",
b,"Entering",a);var h=v(d,b.path,b.method);h?p.ParamValidate(b,c,h,d.definitions)&&p.BodyValidate(b,c,h,d.definitions)&&m():c.status(422).json({errors:"path="+b.path+" not found"})});this.get("/*",function(b,c,m){l.LogObject("event",b,"Entering",a);var h=v(d,b.path,b.method);h?p.ParamValidate(b,c,h,d.definitions)&&m():(l.LogObject("error",b,"no route found",a),c.status(422).json({errors:"path="+b.path+" not found"}))});this.delete("/*",function(b,c,m){l.LogObject("event",b,"Entering",a);var h=v(d,
b.path,b.method);h?p.ParamValidate(b,c,h,d.definitions)&&m():c.status(422).json({errors:"path="+b.path+" not found"})});this.use(function(b,c,m){var h=c.send;c.send=function(m){var u=v(d,b.path,b.method),f=null;u&&u.responseschema&&(d.definitions&&(u.responseschema.definitions=u.responseschema.definitions?Object.assign(u.responseschema.definitions,definitions):d.definitions),f=p.ValidateSchemaErrorObject(JSON.parse(m),u.responseschema));f&&(arguments[0]=JSON.stringify({error:f}),c.status(422));h.apply(c,
arguments);l.LogObject("event",b,"Leaving",a)};m()})}function q(a,b,c){try{JSON.parse(c)}catch(aa){}200!=b?a.res.status(b).json(JSON.stringify(c)):a.next()}function A(a,b){this.use(function(b,c,d){switch(m.services[a].security){case "appkey":var l=p.ServiceKeyName(a);if(!b.headers[l]||b.headers[l]!==m.services[a].key){b="invalid key to service="+l+" value="+b.headers[l];c.status(401).send(b);return}break;case "basic":l=null;b.headers&&(l=b.headers.authorization);if(!l){c.set("WWW-Authenticate",'Basic realm="User Visible Realm"');
c.status(401).send("Authorization header missing");return}l=l.search(/basic /i);if(0!=l)return c.set("WWW-Authenticate",'Basic realm="User Visible Realm"'),Error(401,"basic authorization header needs to start with [basic base64 encoded acckey:clientkey]");case "accesskey":if("accesskey"===m.services[a].security&&(l=null,b.headers&&(l=b.headers.authorization),l||c.status(401).send("Authorization header missing"),l=l.search(/hmac /i),0!=l))return Error(401,"hmac authorization header needs hmac encoded string");
d={req:b,res:c,next:d};l={body:{}};l.body.payload=JSON.stringify({headers:b.headers,servicename:a});l.body.service="keymgr";l.body.method="post";l.body.routena="/grants/check";F(l,c,null,q,d);return}d()})}function I(){return m.services.hasOwnProperty("keymgr")?!0:!1}function C(a){if(I())var b="/images/favicon.png",c="/imagesfavicon.png",d="https://www.cirruswave.com",l="cirrus";else c=b="/images/sample.png",d="/documentation",l="SampleService";m.about&&(m.about.faviconurl&&(b=m.about.faviconurl),
m.about.imageurl&&(c=m.about.imageurl),m.about.url&&(d=m.about.url),m.about.name&&(l=m.about.name));a=a.replace(/REPLFavIcon/g,b);return a.replace("REPLLogo",'<h1 style="background-color:#d8b2d880"><a href="'+d+'"><img src="'+c+'" style="height:32px" />'+l+"</a></h1>")}function B(a,b){a=z.readFileSync(g("index.js")+"/templates/documentation.html","utf8");b.set("Content-Type","text/html");a=C(a);b.send(a)}function D(a,b,c,d,h){var l=c?z.readFileSync(g("index.js")+"/templates/testform.html","utf8"):
z.readFileSync(g("index.js")+"/templates/testrest.html","utf8");b.set("Content-Type","text/html");if(c){c="";var f=null;h&&(f=a.body.service);var u=I();for(y in m.services){var k=m.services[y];if(u){var p=w.resolve(g("index.js"),k.configfilepath);if(!z.existsSync(p)){this.LogObject("error",a,"service="+y+" not deployed configpath="+p+" does not exist",y);continue}}c+="<option class='btn-info form-control' ";f==y&&(c+="selected ");c+="value="+k.security+"@@@"+y;c+=">"+y+"</option>"}l=l.replace(/REPLservicelist/g,
c);var y="";a.body.route&&(y="<input id='rname' type='text' style='display:none' value='"+a.body.route+"' /><input id='rtype' type='text' style='display:none' value='"+a.body.method+"' /><input id='rpayload' type='text' style='display:none' value='"+a.body.payload+"' />");l=l.replace(/REPLRoute/,y)}h?(a='<h2 class="title">Response</h2>',200!=d&&(a+='<h6 style="color:#800000">status='+d+"</h4>"),h=a+"<pre>"+h+"</pre>"):h="";l=l.replace("REPLExtra",h);l=C(l);b.send(l)}function x(a,b,c){var d=null,l=
z.readFileSync(g("index.js")+"/templates/edit.html","utf8");b.set("Content-Type","text/html");if(c){c="";var h=null;d&&(h=a.body.service);var f=I();for(u in m.services){var k=m.services[u];if(f){var p=w.resolve(g("index.js"),k.configfilepath);if(!z.existsSync(p)){this.LogObject("error",a,"service="+u+" not deployed configpath="+p+" does not exist",u);continue}}c+="<option class='btn-info form-control' ";h==u&&(c+="selected ");c+="value="+k.security+"@@@"+u;c+=">"+u+"</option>"}var u='<div id="foodiv" class="form-group row "><label style="vertical-align: middle;" class="col-sm-2">foo</label><div class="col-sm-10"><input type="text" id="foo" name="foo" title="foo" class="form-control"  placeholder="appkey - required only in production mode" aria-describedby="basic-addon2"></div></div>';
l=l.replace(/REPLservicelist/g,c);c="";a.body.route&&(c="<input id='rname' type='text' style='display:none' value='"+a.body.route+"' /><input id='rtype' type='text' style='display:none' value='"+a.body.method+"' /><input id='rpayload' type='text' style='display:none' value='"+a.body.payload+"' />");l=l.replace(/REPLRoute/,c).replace(/REPLForm/,u)}d?(a='<h2 class="title">Response</h2>',200!=status&&(a+='<h6 style="color:#800000">status='+status+"</h4>"),d=a+"<pre>"+d+"</pre>"):d="";l=l.replace("REPLExtra",
d);l=C(l);b.send(l)}function M(a,b,c){if(a.params.servicename)if(c=m.services[a.params.servicename])if(c&&c.configfilepath){var d=g("index.js");H&&(d=H);c=w.resolve(d,c.configfilepath);z.existsSync(c)?(a=require(c),b.json(a.routes)):b.status(404).send("service="+a.params.servicename+" not deployed")}else c="servicename="+a.params.servicename+" not found",this.LogObject("error",a,c,a.params.servicename),b.status(404).send(c);else this.LogObject("error",a,"servicename="+a.params.servicename+" not found in serviceconfig.json",
a.params.servicename);else b.status(422).send("servicename is required")}function N(a,b,c){if(a.params.servicename)if(a.query.r)if(a.query.m)if(c=m.services[a.params.servicename]){var d=g("index.js");H&&(d=H);c=require(w.resolve(d,c.configfilepath));(a=t(c,a.query.r,a.query.m))||(a=c.routes[0]);a.configured?b.json(a):b.status(422).send("route not configured")}else c="servicename="+a.params.servicename+" not found in serviceconfig.json",this.LogObject("error",a,c,a.params.servicename),b.status(403).send(c);
else b.status(422).send("method is required");else b.status(422).send("routename is required");else b.status(422).send("servicename is required")}function E(a,b,c){try{var d=JSON.parse(c)}catch(P){d={data:c}}a.res.headerSent||D(a.req,a.res,a.fService,b,JSON.stringify(d,0,2))}function F(a,c,b,d,m){b&&"object"===typeof b?b=b.services[a.body.service]:(b=g("index.js")+"/deploy/lib/serviceconfig.json",b=p.GetServiceConfig(b,a.body.service));S&&S.dnsservicename&&"localhost"==b.hostname&&(b.hostname=a.body.service,
this.LogObject("trace",a,"ExecuteTestApp hostname="+b.hostname,"ExecuteTestApp"));var h={},l=null,f=null;switch(b.security){case "basic":case "accesskey":l={};l.security=b.security;l.nonce=W++;l.acckey=a.body.acckey;l.secret=a.body.secretna;break;case "appkey":f=a.body.appkey?p.MakeKeyServiceAndKeyValue(a.body.service,a.body.appkey):p.MakeKeyServiceAndKeyValue(a.body.service,b.key)}switch(a.body.method){case "post":try{""!==a.body.payload&&(h=JSON.parse(a.body.payload))}catch(V){c.json({error:"payload is not proper json"});
break}p.PostPutHttp("POST",l,f,b.protocol,b.hostname,a.body.routena,b.port,JSON.stringify(h),d,m);break;case "put":try{""!==a.body.payload&&(h=JSON.parse(a.body.payload))}catch(V){c.json({error:"payload is not proper json"});break}p.PostPutHttp("PUT",l,f,b.protocol,b.hostname,a.body.routena,b.port,JSON.stringify(h),d,m);break;case "static":case "get":p.GetHttpProper(l,f,b.protocol,b.hostname,a.body.routena,b.port,"",d,m);break;case "delete":p.DeleteHttp(l,f,b.protocol,b.hostname,a.body.routena,b.port,
"",d,m)}}function K(a,b){var c=z.readFileSync(g("index.js")+"/templates/services.html","utf8"),d="",h="",l=!1;m.services.hasOwnProperty("keymgr")&&(l=!0);var f="";l||(f="There are system services available. To see the list of services, please run the keymgr service. For an example of how to run keymgr system service, please see corresponding usage in runsampleservice.bash in examples directory.");for(var k in m.services){var p="",y=m.services[k];if(l){var e=w.resolve(g("index.js"),y.configfilepath);
if(!z.existsSync(e)){this.LogObject("error",a,"service="+k+" not deployed configpath="+e+" does not exist",k);continue}}d+="<li><a class='scrollto' href='#"+k+"'>"+k+"</a></li>";p+="<p><b>"+y.description+"</b></p><br/>";p+="<p><b>Documentation: </b><a class='btn-cirrus' href=/service/"+k+">"+k+"</a></p>";if(y.pathsamples){var q=null;e=w.resolve(g("index.js"),y.pathsamples+"/examples.json");try{q=require(e)}catch(R){this.LogObject("error",a,"samples for "+e+" do not exist diname="+g("index.js"),k)}q&&
(p+="<p><b>Examples:</b><a class='btn-cirrus' href=/samples/"+k+">"+k+"</a></p>")}p+="<br/>";l&&(p+="For an example of how to run "+k+" system service, please see corresponding usage in runsampleservice.bash in examples directory.",p+="<br/>",p+="<p><b>Launch command: </b>node ../cirruswave/cirruswaverouteservice.js -s "+k,y.init&&y.init.optionschema&&(p+=" -i &lt;option json&gt;</p>",p+="<p>&lt;option json&gt; needs to conform to this schema:</p>",p+="<pre>"+JSON.stringify(y.init.optionschema,0,
2)+"</pre>",y.init.options&&(p+="<p>default &lt;option json&gt;:</p>",p+="<pre>"+JSON.stringify(y.init.options,0,2)+"</pre>")));h+='<section id="REPLservicename" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",p).replace(/REPLservicename/g,k)}c=c.replace("REPLNotice",f).replace("REPLservicelist",d).replace("REPLsectioncontent",h);c=C(c);b.send(c)}function J(a,b,c,d){if(a){var h=m.services[a];
if(h)if(h.configfilepath){d=z.readFileSync(g("index.js")+"/templates/routes.html","utf8");d=d.replace("REPLservicedescription",h.description);var f="",l="",k=g("index.js");H&&(k=H);try{var p=require(w.resolve(k,h.configfilepath))}catch(Q){this.LogObject("error",b,Q,a);c.status(422).send(Q);return}for(var e in p.routes)if(b=p.routes[e],b.configured){h="";h+="<h6><pre>"+b.description+"</pre></h6>";h+="<h6>method="+b.type+"</h6>";b.paramschema&&(h+="<br><pre>parameter="+JSON.stringify(b.paramschema,
0,2)+"</pre>");b.bodyschema&&(h+="<br><pre>payload="+JSON.stringify(b.bodyschema,0,2)+"</pre>");b.responseschema&&(h+="<br><pre>returnValue="+JSON.stringify(b.responseschema,0,2)+"</pre>");if(b.examples&&Array.isArray(b.examples)&&0<b.examples.length){h+="<br><h6>examples:</h6><pre>";for(var q in b.examples)0<q&&(h+="<br>"),b.examples[q].param&&(h+="params="+X(b.examples[q].param)),b.examples[q].payload&&(h+="payload="+JSON.stringify(b.examples[q].payload,0,2));h+="</pre>"}f+="<li><a class='scrollto' href='#"+
b.route+"'>"+b.route+"</a></li>";l+='<section id="REPLroutename" class="doc-section"><h2 class="section-title">REPLroutename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",h).replace(/REPLroutename/g,b.route)}d=d.replace(/REPLservice/g,a).replace("REPLroutelist",f).replace("REPLsectioncontent",l).replace(/REPLHeader/,"Documentation for the service").replace(/REPLSectionHeader/g,"API Routes");d=C(d);c.send(d)}else a="servicename="+a+" has no configfilepath",
this.LogObject("trace",b,a,"RenderEditServices"),c.status(422).send(a);else a="servicename="+a+" not found in serviceconfig.json",this.LogObject("error",b,a,"RenderEditServices"),c.status(422).send(a)}else c.status(422).send("servicename is required")}function L(a,b,c){if(a){var d=m.services[a];if(!d)this.LogObject("error",b,"servicename "+a+" not found in serviceconfig.json",a);else if(d.pathsamples){var h=null,f=w.resolve(g("index.js"),d.pathsamples+"/examples.json");try{h=require(f)}catch(ba){this.LogObject("trace",
b,"samples for "+f+" do not exist","RenderEditServices")}b=z.readFileSync(g("index.js")+"/templates/routes.html","utf8");b=b.replace("REPLservicedescription",d.description);var l=f="";if(h)for(var k in h.Samples){var p=h.Samples[k],e="";e+="<h6><pre>"+p.description+"</pre></h6>";for(var q in p.code){var A=z.readFileSync(w.resolve(g("index.js"),d.pathsamples+"/"+p.code[q]),"utf8"),n="code";p.code[q].search(".sh")==p.code[q].length-3&&(n="bashcode");e=p.code[q].search(".html")==p.code[q].length-5?e+
("<div>"+A+"</div>"):e+("<pre class='"+n+"'>"+A+"</pre>")}f+="<li><a class='scrollto' href='#"+k+"'>"+k+"</a></li>";l+='<section id="REPLroutename" class="doc-section"><h2 class="section-title">REPLroutename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",e).replace(/REPLroutename/g,k)}b=b.replace(/REPLservice/g,a).replace("REPLroutelist",f).replace("REPLsectioncontent",l).replace(/REPLHeader/,"Sample code for the service").replace(/REPLSectionHeader/g,
"Examples");b=C(b);c.send(b)}}else c.status(422).send("servicename is required")}function a(a,b){this.startservice(a,null,null,b)}function b(a,b,c,d){var h=null,f=g("index.js");b&&(h=require(w.resolve(b,c)),require(w.resolve(b,h.services[a].configfilepath)),f=b);c||(c="./deploy/lib/serviceconfig.json");H=b;this.initialize(a,h,d);h&&(m=h);this.setuproutes(f,m.services[a].configfilepath);b=m.services[a];var k=b.port;c=w.resolve(f,c);b.key=p.EstablishKey(c,a);console.log("                                                           \ncirruwave image goes here \n                    CirrusWave                      \n");
var l=this;b.certPath?(c=w.resolve(f,"./"+b.certPath+".key"),f=w.resolve(f,"./"+b.certPath+".crt"),f={key:z.readFileSync(c),cert:z.readFileSync(f)},Y.createServer(f,this).listen(k,function(){l.LogObject("trace",null,"Securely listening on port "+k,a)})):this.listen(k,function(){l.LogObject("trace",null,"listening on port "+k,a)})}function c(a,b){b=require(w.resolve(a,b));for(var c in b.routes){var d=b.routes[c];if(d.configured){var h=w.resolve(a,d.routeclass);"static"===d.type?this.use(d.route,k.static(h)):
(h=require(h),this[d.type](d.route,h[d.routefunction]))}}}function f(a,b,c,d){var h={};h.level=a;null!=b&&(h.url=b.originalUrl,h.method=b.method,h.useragent=b.headers["user-agent"],h.host=b.host);this.logger[a](c,h,{label:d})}var k=require("express"),d=require("body-parser"),h=require("cookie-parser"),m=require("./deploy/lib/serviceconfig.json"),p=n(1,0),Y=require("https"),z=require("fs"),w=require("path");require("util");n(2,0);var X=require("htmlencode").htmlEncode,H=null;try{var T=w.resolve(g("index.js"),
"./lib/deploy.json");console.log(T);var Z=z.readFileSync(T,"UTF8"),S=JSON.parse(Z)}catch(l){"ENOENT"!=l.code&&console.log(l.code+" - "+l.message)}var W=17986;e=function(){var d=k.call(this)||this;var h=require("winston"),m=h.format.printf(function(a){return a.timestamp+" ["+a.label+"]  "+a.level+": "+a.message}),p=[];p.push(new h.transports.Console);d.logger=h.createLogger({levels:{trace:5,event:4,debug:3,info:2,warn:1,error:0},transports:p,level:"trace",colorize:!0,prettyPrint:!0,silent:!1,format:h.format.combine(h.format.label({label:"right meow!"}),
h.format.splat(),h.format.timestamp(),m)});d.LogObject=f;d.initialize=U;d.startservice=b;d.startsystemservice=a;d.setuproutes=c;d.validatesecurekey=A;d.BodyValidate=G;return d};$jscomp.inherits(e,k);e=new e;r.exports=e;return r.exports};r[1]=function(r,e){function v(a,b){a=B.createHmac("sha256",a);a.update(b);return a.digest("hex")}function t(a,b){var c=n(2,1);if(a.secret&&a.acckey){if("accesskey"===a.security){var f=new Date,k=a.acckey+":"+a.nonce;b.Authorization="hmac "+k+":"+c.Sign(a.secret,k+
":"+f);b.Date=f;return}if("basic"===a.security){c=Buffer.from(a.acckey+":"+a.secret).toString("base64");b.Authorization="basic "+c;return}}a.Authorization?(b.Authorization=a.Authorization,c=b.Authorization.indexOf("hmac "),0!=c?(c=b.Authorization.search(/basic /i),0!==c&&console.log("badly formed authorization string - needs to start with hmac")):(c=b.Authorization.slice(c+5),c.split(":"),b.Date=a.Date)):console.log("missing authorization string")}function D(a){if(!a)return null;var b="",c;for(c in a)"object"===
typeof a[c]?(""!=b&&(b+="&"),b+=c+"="+JSON.stringify(a[c])):"array"!==typeof a[c]&&(""!=b&&(b+="&"),b+=c+"="+a[c]);return b}var G=require("http"),q=require("https"),A=require("fs"),I=require("path"),C=require("querystring"),B=require("crypto"),x=require("jsonschema").Validator;e.Cipher=function(a,b){var c=B.randomBytes(16).toString("hex").slice(0,16),f=B.createHash("sha256").update(a).digest("hex");f=f.slice(0,32);b=B.createCipheriv("aes-256-ctr",f,c).update(b).toString("hex");a=v(a,b);return c+":::"+
b+":::"+a};e.Decipher=function(a,b){var c=b.split(":::");b=c[0];var f=c[2],k=v(a,c[1]);if(f!=k)return null;c=new Buffer(c[1],"hex");a=B.createHash("sha256").update(a).digest("hex");a=a.slice(0,32);return B.createDecipheriv("aes-256-ctr",a,b).update(c)};e.ValidateSchemaErrorObject=function(a,b){a=(new x).validate(a,b);if(a.errors.length){b="";for(var c in a.errors)b+=a.errors[c].stack+" ";return b}return null};e.ValidateSchema=function(a,b,c,f){return(a=this.ValidateSchemaErrorObject(a,b))?(f.status(422).json({errors:a}),
!1):!0};e.BodyValidate=function(a,b,c,f){return c&&c.bodyschema?(f&&(c.bodyschema.definitions=c.bodyschema.definitions?Object.assign(c.bodyschema.definitions,f):f),this.ValidateSchema(a.body,c.bodyschema,a,b)):!0};e.ParamValidate=function(a,b,c,f){if(c&&c.paramschema){var k=a.params[0],d=c.route;"/"==d.slice(0,1)&&(d=d.slice(1));"/"==k.slice(0,1)&&(k=k.slice(1));"/"==d.slice(-1)&&(d=d.slice(0,-1));"/"==k.slice(-1)&&(k=k.slice(0,-1));for(var h={};""!=d;){var m=!1;":"==d.slice(0,1)&&(m=!0,d=d.slice(1));
var p=d.search("/"),e=k.search("/");if(0<=p){var q=d.slice(0,p);d=d.slice(p+1);var g=k.slice(0,e);k=k.slice(e+1)}else q=d.slice(0),d="",g=k.slice(0),k="";m&&(m=Number(g),isNaN(m)?h[q]=g:h[q]=m)}f&&(c.paramschema.definitions=c.paramschema.definitions?Object.assign(c.paramschema.definitions,f):f);f=a.query;for(p in f)isNaN(f[p])||(f[p]=Number(f[p]));h=Object.assign({},h,f);return this.ValidateSchema(h,c.paramschema,a,b)}return!0};e.deep_value=function(a,b){b=b.split(".");for(var c in b)a=a[b[c]];return a};
var O=require("os");e.GetIPFromService=function(a){var b=O.networkInterfaces(),c=null;a.networkname&&(c=a.networkname);a=null;for(var f in b){for(var k in b[f]){var d=b[f][k];"IPv4"!==d.family||d.internal||(a=d.address)}if(f==c)break}return a};e.getFunctionsOfObject=function(a){return Object.getOwnPropertyNames(a).filter(function(b){return"function"==typeof a[b]})};e.MakeDir=function(a){var b=require("child_process").exec;b("mkdir  "+a)};e.WriteFile=function(a,b){try{return A.writeFileSync(a,b,"utf8"),
!0}catch(c){return!1}};e.FormatYYYYMMDD=function(a){return a.getUTCFullYear()+"-"+("0"+(a.getUTCMonth()+1)).slice(-2)+"-"+("0"+a.getUTCDate()).slice(-2)};e.FormatYYYYMMDDHHMMSS=function(a){return this.FormatYYYYMMDD(a)+"-"+("0"+a.getUTCHours()).slice(-2)+"-"+("0"+a.getUTCMinutes()).slice(-2)+"-"+("0"+a.getUTCSeconds()).slice(-2)};e.FormatYYYYMMDDHHMMSSColon=function(a){return this.FormatYYYYMMDD(a)+"T"+("0"+a.getUTCHours()).slice(-2)+":"+("0"+a.getUTCMinutes()).slice(-2)+":"+("0"+a.getUTCSeconds()).slice(-2)};
e.Median=function(a){a.sort(function(a,b){return a-b});var b=a.length,c=Math.floor(b/2),f;1===b%2?f=a[c]:f=(a[c-1]+a[c])/2;return f};e.LowPassFilter=function(a,b,c){if(.1<Math.abs(b)){var f=(b-a)/a;f>c?b=a*(1+c):f<c&&(b=a*(1-c))}return b};e.PostPutHttp=function(a,b,c,f,k,d,h,m,p,e){var g={"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":m.length};c&&(g[c.keyName]=c.keyValue);if(b&&"object"===typeof b){if("accesskey"===b.security||"basic"===
b.security)t(b,g),b=null;b=null}a={hostname:k,port:h,path:d,method:a,headers:g,json:!0};b&&(a.auth=b);b=G;if("https"==f||"https:"==f)a.rejectUnauthorized=!1,b=q;f=b.request(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&(console.log("Error statusCode="+a.statusCode),b&&console.log("data="+JSON.stringify(b)));p&&p(e,a.statusCode,b)})});f.on("error",function(a){console.log("problem with request: "+a.message);p&&p(e,500,a)});f.write(m);
f.end()};e.PostHttpAuth=function(a,b,c,f,k,d,h,m,p){this.PostPutHttp("POST",a,b,c,f,k,d,h,m,p)};e.PostHttp=function(a,b,c,f,k,d,h,m){this.PostPutHttp("POST",null,a,b,c,f,k,d,h,m)};e.PutHttp=function(a,b,c,f,k,d,h,m){this.PostPutHttp("PUT",null,a,b,c,f,k,d,h,m)};e.GetHttpAuth=function(a,b,c,f,k){a=G.request({hostname:a,port:c,path:b+"/"+f,method:"GET",headers:{"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":f.length},json:!0},function(a){var b=
"";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);k(a.statusCode,b)})});a.on("error",function(a){console.log("problem with request: "+a.message)});a.end()};e.GetDeleteHttp=function(a,b,c,f,k,d,h,m,p,e){var g={"User-Agent":"app-bt/0.0.1","Cache-Control":"no-cache"};c&&(g[c.keyName]=c.keyValue);if(b&&"object"===typeof b){if("accesskey"===b.security||"basic"===b.security)t(b,g),b=null;b=null}m&&(m=C.escape(m),
d=d+"/?"+m);a={hostname:k,port:h,path:d,method:a,headers:g,json:!0};b&&(a.auth=b);b=G;if("https"==f||"https:"==f)a.rejectUnauthorized=!1,b=q;f=b.request(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);p(e,a.statusCode,b)})});f.on("error",function(a){console.log("problem with request: "+a.message)});f.end()};e.GetHttpProper=function(a,b,c,f,k,d,h,m,p){this.GetDeleteHttp("GET",a,b,c,f,
k,d,h,m,p)};e.DeleteHttp=function(a,b,c,f,k,d,h,m,p){this.GetDeleteHttp("DELETE",a,b,c,f,k,d,h,m,p)};var M=0,N=require("url");try{var E=I.resolve(g("cirruswaveutil.js"),"./lib/deploy.json"),F=A.readFileSync(E,"UTF8"),K=JSON.parse(F)}catch(a){"ENOENT"!=a.code&&console.log(a.code+" - "+a.message)}e.RestTaskCall=function(a,b,c){var f=!1,k={};a.payload&&console.log("\t\tpayload ="+JSON.stringify(a.payload));var d=null;if(a.service&&a.servicepath){if(a.sysservice){if(!a.serviceconfig){k="Parameter error: Task="+
a.name+" does not contain serviceconfig";console.error(k);b(c,404,JSON.stringify(k));return}var h=this.GetServiceConfig(a.serviceconfig,a.service)}else{if(!a.appserviceconfig){k="Parameter error: Task="+a.name+" does not contain appserviceconfig";console.error(k);b(c,404,JSON.stringify(k));return}h=this.GetServiceConfig(a.appserviceconfig,a.service);if(!h){if(!a.serviceconfig){k="Parameter error: Task="+a.name+" does not contain serviceconfig";console.error(k);b(c,404,JSON.stringify(k));return}h=
this.GetServiceConfig(a.serviceconfig,a.service)}}if(!(h&&"object"==typeof h&&h.hasOwnProperty("protocol")&&h.hasOwnProperty("hostname")&&h.hasOwnProperty("port"))){k="Parameter error: Task="+a.name+" has unrecognized service="+a.service+" sc="+JSON.stringify(h);console.error(k);b(c,404,JSON.stringify(k));return}K&&K.dnsservicename&&"localhost"==h.hostname&&(h.hostname=a.service);f=!0;k.protocol=h.protocol;k.hostname=h.hostname;k.port=h.port;switch(h.security){case "basic":case "accesskey":d={};d.security=
h.security;d.nonce=M++;d.acckey=a.acckey;d.secret=a.secretna;break;case "appkey":k.key=a.appkey?this.MakeKeyServiceAndKeyValue(a.service,a.appkey):this.MakeKeyServiceAndKeyValue(a.service,h.key)}k.pathname=a.servicepath;0!=k.pathname.search("/")&&(k.pathname="/"+k.pathname)}if(a.url||f)switch(f=null,a.payload&&(f=a.payload),a.url&&(k=N.parse(a.url),k.key=null),a.method){case "POST":a="";f&&(a=JSON.stringify(f));this.PostPutHttp("POST",d,k.key,k.protocol,k.hostname,k.pathname,k.port,a,b,c);break;case "PUT":a=
"";f&&(a=JSON.stringify(f));this.PostPutHttp("PUT",d,k.key,k.protocol,k.hostname,k.pathname,k.port,a,b,c);break;case "GET":a="";f&&(a=D(f));this.GetHttpProper(d,k.key,k.protocol,k.hostname,k.pathname,k.port,a,b,c);break;case "DELETE":a="";f&&(a=D(f));this.DeleteHttp(d,k.key,k.protocol,k.hostname,k.pathname,k.port,a,b,c);break;default:k=a.hasOwnProperty("name")?"Parameter error: Task="+a.name+" has unrecognized method="+a.method:"Parameter error: unrecognized method="+a.method,console.error(k),b(c,
404,{error:k})}else a.func?(a.payload&&JSON.parse(JSON.stringify(a.payload)),k=eval("this.to."+a.func+"(payload)"),b(c,200,k)):b(c,200,{})};e.ServiceKeyName=function(a){return a+"-api-key"};e.MakeKeyServiceAndKeyValue=function(a,b){if(!b)return null;var c={};c.keyName=this.ServiceKeyName(a);c.keyValue=b;return c};e.EstablishKey=function(a,b){var c=A.readFileSync(a,"utf8");c=JSON.parse(c);var f=c.services;if(!f||!f[b]||"appkey"!==f[b].security)return null;f[b].key||(f[b].key=this.GenerateKeyFromDate((new Date).toString()),
A.writeFileSync(a,JSON.stringify(c,0,2),"UTF8"));return f[b].key};e.GenerateKeyFromDate=function(a){return B.createHash("md5").update(a).digest("hex")};e.GetServiceConfig=function(a,b){var c=A.readFileSync(a,"utf8");c=JSON.parse(c);if(!c)return null;var f=c.services;if(!f||!f[b])return null;c=f[b];f[b].security||(f[b].security="nokey",A.writeFileSync(a,JSON.stringify(c,0,2),"UTF8"));return f[b]};e.PriorityQueue=function(a){this._comparator=a||this.DEFAULT_COMPARATOR;this._elements=[];this.DEFAULT_COMPARATOR=
function(a,c){if("number"===typeof a&&"number"===typeof c)return a-c;a=a.toString();c=c.toString();return a==c?0:a>c?1:-1};e.PriorityQueue.isEmpty=function(){return 0===this.size()};this.peek=function(){if(this.isEmpty())throw Error("PriorityQueue is empty");return this._elements[0]};this.deq=function(){return this._elements.length?this._elements.shift():null};this.enq=function(a){a=this._elements.push(a);for(var b=a-1;0<b;){var f=b-1;if(0>=this._compare(b,f))break;this._swap(f,b);b=f}return a};this.size=
function(){return this._elements.length};this.getElement=function(a){return 0>a||a>=this.size()?null:this._elements[a]};this.getElements=function(a){return this._elements};this.forEach=function(a){return this._elements.forEach(a)};this._compare=function(a,c){return this._comparator(this._elements[a],this._elements[c])};this._swap=function(a,c){var b=this._elements[a];this._elements[a]=this._elements[c];this._elements[c]=b}};var J=require("cacheman");e.TtlCache=function(a,b,c){if(!a)return null;if(b||
c){var f={};b&&(f.ttl=b);c&&(f.engine=c);this.cache=new J(a,f)}else this.cache=new J(a);this.Set=function(a,b,c){this.cache.set(a,b,c)};this.Get=function(a,b){this.cache.get(a,b)}};var L=require("dgram");e.Udp=function(a,b,c,f){this.server=L.createSocket("udp4");a||b?(this.server.bind({address:c,port:f}),this.server.on("listen",a),this.server.on("message",b),this.broadcastMode=!1):this.broadcastMode=!0;this.address=function(){return this.server.address().address};this.port=function(){return this.server.address().port};
this.broadcast=function(a,b,c){if(this.broadcastMode){var d=new Buffer(JSON.stringify(c));this.server.send(d,0,d.length,b,a,function(){console.log("Sent '"+d+"'")})}}};return r.exports};r[2]=function(r,e){function v(a,b){return{status:a,message:b}}function t(a,b){c.storage.Get(a,c.folderkeys,function(c,d){c?b(v(404,"acckey="+a+" "+c),null):b(null,d)})}function x(a,b){t(a,function(a,c){a?b(a,null):(a=JSON.parse(JSON.stringify(c)),delete a.secret,b(null,a))})}function G(a,b){c.storage.Get(a,c.folderids,
function(c,d){c?b(v(404,"client="+a+" "+c),null):b(null,d)})}function q(a,b,m){c.storage.Put(a,b,c.folderids,function(d,h){d?m(v(404,d),null):"file"===c.type?m(null,h):c.storage.Put(b.acckey,b,c.folderkeys,function(b,c){b&&I(a,!1,function(a,c){a?c(v(404,a),null):c(v(404,b),null)});m(null,c)})})}function A(a,b,c,f,k){G(a,function(d,h){var m={services:[]};d||(m=h);m.acckey=b;m.secret=c;m.clientid=a;for(var p in f)0>m.services.indexOf(f[p])&&m.services.push(f[p]);q(a,m,k)})}function I(a,b,m){G(a,function(d,
h){c.storage.Delete(a,c.folderids,function(a,d){a?m(a,null):"file"!==c.type&&b?c.storage.Delete(h.acckey,c.folderkeys,function(a,b){a?m(a,null):m(null,"OK")}):m(null,"OK")})})}function C(a,b){if(a=a.authorization)if(0!=a.search(/basic /i))b(v(403,"basic authorization header needs to start with basic"),null);else{a=a.slice(6);var c=Buffer.from(a,"base64").toString().split(":"),d=c[0];t(d,function(a,h){a?b(v(403,"acckey="+d+" not found"),null):c[1]===h.secret?b(null,h):b(v(403,"could not authenticate"),
null)})}else b(v("403","Authorization header missing"),null)}function B(a,b){var c=a.authorization;if(c)if(0!=c.search(/hmac /i))C(a,b);else{var d=c.slice(5).split(":"),h=d[0];t(h,function(c,f){if(c)b(v(403,"acckey="+h+" not found"),null);else{var m=a.date,k=d.splice(-1,1)[0];c=d.join(":");E(f.secret,c+(":"+m))==k?b(null,f):b(v(403,"could not authenticate"),null)}})}else b(v(403,"Authorization header missing"),null)}function D(a,b,c){var d=(new Date).valueOf(),h=Math.round(Math.random()*d),f=F.GenerateKeyFromDate(h.toString());
h=Math.round(Math.random()*d);d=F.GenerateKeyFromDate(h.toString());A(a,f,d,b,c)}function O(a){var b=F.GetServiceConfig(J,a);return b?b:b=F.GetServiceConfig(L,a)}function M(a,b,c){t(a,function(a,d){a?c(a,null):(a=O(b))?"accesskey"!==a.security&&"basic"!==a.security?c(v(403,"access is forbidden to service="+b),null):(b&&0>d.services.indexOf(b)&&d.services.push(b),q(d.clientid,d,c)):c(v(404,"No such service="+b),null)})}function N(a,b,c){t(a,function(a,d){a=O(b);"accesskey"!==a.security&&"basic"!==
a.security?c(v(403,"access is forbidden"),null):(a=d.services.indexOf(b),0>a?c(v(403,"no access to service="+b),null):(d.services.splice(a,1),q(d.clientid,d,c)))})}function E(a,b){a=K.createHmac("sha256",a);a.update(b);return a.digest("hex")}var F=n(1,2),K=require("crypto"),J=g("apikeymgr.js")+"/deploy/lib/serviceconfig.json",L=J,a=g("apikeymgr.js");require("fs");var b=require("path"),c=null,f=n(3,2),k=n(4,2);e.initialize=function(d){var h="./deploy/lib/aclconfig.json";if(d)switch(a=d.appdir,h=d.aclconfig,
L=b.resolve(a,d.appserviceconfig),c={type:"file"},d.persistence&&(c=d.persistence),c.folderkeys="pc-keyfolder/keys",c.folderids="pc-keyfolder/ids",c.type){case "file":c.storage=new k(d);break;case "s3":c.storage=new f({encseckey:d.secret,bucketName:c.bucketname,acckey:c.acckey,secretkey:c.secret,region:c.region})}d.aclconfpath=b.resolve(a,h)};e.Sign=function(a,b){return E(a,b)};e.RouteAllocateAccessKeys=function(a,b){D(a.params.clientid,[],function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c)})};
e.RouteGetClientFromClientid=function(a,b){G(a.params.clientid,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c)})};e.RouteGetClientFromAcckey=function(a,b){t(a.params.acckey,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c)})};e.RouteRevokeClient=function(a,b){I(a.params.clientid,!0,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json({data:"OK"})})};e.RouteGrantAccess=function(a,b){M(a.params.acckey,a.params.servicename,function(a,c){a?
b.status(a.status).json(a.message):b.status(200).json(c)})};e.RouteRevokeAccess=function(a,b){N(a.params.acckey,a.params.servicename,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c)})};e.RouteGetAccessServices=function(a,b){x(a.params.acckey,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c.services)})};e.RouteGetAccessOneService=function(a,b){x(a.params.acckey,function(c,d){c?b.status(c.status).json(c.message):0>d.services.indexOf(a.params.servicename)?
b.status(404).json("access was never granted to client="+d.clientid+" for service="+servicename):b.status(200).json(a.params.servicename)})};e.RouteCheckAccessOneService=function(a,b){a.body.headers?B(a.body.headers,function(c,d){c?b.status(c.status).json(c.message):0>d.services.indexOf(a.body.servicename)?b.status(404).json("access was never granted to client="+o.clientid+" for service="+servicename):b.status(200).json({servicename:a.body.servicename})}):b.status(400).json("headers missing in the body of request")};
return r.exports};r[3]=function(g,e){var v=n(1,3),r=require("aws-sdk"),t=n(5,3);e=function(e){var q=t.call(this)||this;q.bucketName=e.bucketName;q.encseckey=e.encseckey;r.config.region=e.region;r.config.update({accessKeyId:e.acckey,secretAccessKey:e.secretkey});return q};$jscomp.inherits(e,t);e.prototype.Delete=function(e,q,g){(new r.S3({params:{Bucket:this.bucketName+"/"+q}})).deleteObject({Key:e},function(q,n){if(q)return console.log("Error in posting Content ["+q+"]"),!1;console.log("Successfully Deleted Key = "+
e);g&&g(null,"OK")}).on("httpUploadProgress",function(e){console.log(Math.round(e.loaded/e.total*100)+"% done")})};e.prototype.Get=function(e,q,g){var n=this;(new r.S3({params:{Bucket:this.bucketName+"/"+q}})).getObject({Key:e},function(e,q){if(e)return e="Error in getting Content ["+e+"]",console.log(e),g&&g(e,null),!1;e=q.Body.toString();n.encseckey&&(e=v.Decipher(n.encseckey,e),e=e.toString("UTF8"));console.log("Successfully Get Key = "+e);g&&g(null,JSON.parse(e))}).on("httpUploadProgress",function(e){console.log(Math.round(e.loaded/
e.total*100)+"% done")})};e.prototype.ListRecursive=function(e,g,n){var q=new r.S3({params:{Bucket:this.bucketName+"/"+e}});g={Bucket:this.bucketName,MaxKeys:100,ContinuationToken:g};null===e?g.Delimiter="/":g.Prefix="*"!=e?e:"";q.listObjectsV2(g,function(g,q){if(g)return strErr="Error in listing Contents ["+g+"]",console.log(strErr),n&&n(strErr,null),!1;n&&n(null,q);q.NextContinuationToken&&(console.log("continue="+q.NextContinuationToken),this.ListRecursive(e,q.NextContinuationToken))}).on("httpUploadProgress",
function(e){console.log(Math.round(e.loaded/e.total*100)+"% done")})};e.prototype.Listirectories=function(e){this.ListRecursive(null,null,e)};e.prototype.ListObjects=function(e,g){this.ListRecursive(e,null,g)};e.prototype.Put=function(e,g,n,t){n=new r.S3({params:{Bucket:this.bucketName+"/"+n}});var q=JSON.stringify(g);this.encseckey&&(q=v.Cipher(this.encseckey,q));n.putObject({Key:e,Body:q,ContentType:"text/plain; charset=utf-8"},function(e,q){if(e)return e="Error in posting Content ["+e+"]",console.log(e),
t&&t(e,null),!1;console.log("Successfully posted Content");t&&t(null,g)}).on("httpUploadProgress",function(e){console.log(Math.round(e.loaded/e.total*100)+"% done")})};g.exports=e;return g.exports};r[4]=function(g,e){var r=n(1,4),t=n(5,4),x=require("fs"),D=require("path");e=function(e){var g=t.call(this)||this;g.aclpath=e.aclconfpath;g.encseckey=e.secret;g.appdir=e.appdir;console.log(g.appdir);console.log(e.aclconfig);g.aclpath=D.resolve(g.appdir,e.aclconfig);g.acl=null;x.existsSync(g.aclpath)&&(g.acl=
g.ReadAclFromFile(g.aclpath));g.acl||(g.acl={},g.WriteAclToFile(g.aclpath));return g};$jscomp.inherits(e,t);e.prototype.CreateSignature=function(e){return crypto.createHash("sha256").update(e).digest("hex")};e.prototype.WriteAclToFile=function(e){e=JSON.stringify(this.acl);e=r.Cipher(this.encseckey,e);x.writeFileSync(this.aclpath,e)};e.prototype.ReadAclFromFile=function(e){e=x.readFileSync(this.aclpath,"utf8");e=r.Decipher(this.encseckey,e);if(!e)return null;e=e.toString("UTF8");return JSON.parse(e)};
e.prototype.Delete=function(e,g,n){var q=-1;if("pc-keyfolder/keys"===g){for(var r in this.acl)this.acl[r].acckey==e&&(q=r);if(-1===q){n("key "+e+" not found",null);return}}else q=e;delete this.acl[q];n&&n(null,"OK")};e.prototype.Listirectories=function(){};e.prototype.ListObjects=function(e){};e.prototype.Get=function(e,g,n){if("pc-keyfolder/keys"===g){for(var q in this.acl){var r=this.acl[q];if(r.acckey==e){r.clientid=q;n(null,r);return}}console.log("name="+e+" folder="+g);n("key "+e+" not found",
null)}else this.acl[e]?(this.acl[e].clientid=e,n(null,this.acl[e])):(console.log("name="+e+" folder="+g),n("client "+e+" does not exist",null))};e.prototype.Put=function(e,g,n,r){this.acl[e]||(this.acl[e]={services:[]});this.acl[e].acckey=g.acckey;this.acl[e].secret=g.secret;for(var q in g.services)0>this.acl[e].services.indexOf(g.services[q])&&this.acl[e].services.push(g.services[q]);this.WriteAclToFile(this.aclpath);r(null,this.acl[e])};g.exports=e;return g.exports};r[5]=function(g,e){g.exports=
function(){"storagedriver"===this.constructor.name&&(console.error("can not instantiate storage driver"),process.exit(1));var e=[];void 0===this.Get&&e.push("Get");void 0===this.Delete&&e.push("Delete");void 0===this.Listirectories&&e.push("Listirectories");void 0===this.ListObjects&&e.push("ListObjects");void 0===this.Put&&e.push("Put");e.length&&(console.error(e+" required on "+this.constructor.name+" class"),process.exit(1))};return g.exports};if("object"===typeof module)module.exports=n(0);else return n(0)})();
