var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(n){var g=function(){};g.prototype=n;return new g};$jscomp.underscoreProtoCanBeSet=function(){var n={a:!0},g={};try{return g.__proto__=n,g.a}catch(q){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(n,g){n.__proto__=g;if(n.__proto__!==g)throw new TypeError(n+" is not extensible");return n}:null;
$jscomp.inherits=function(n,g){n.prototype=$jscomp.objectCreate(g.prototype);n.prototype.constructor=n;if($jscomp.setPrototypeOf){var q=$jscomp.setPrototypeOf;q(n,g)}else for(q in g)if("prototype"!=q)if(Object.defineProperties){var t=Object.getOwnPropertyDescriptor(g,q);t&&Object.defineProperty(n,q,t)}else n[q]=g[q];n.superClass_=g.prototype};$jscomp.owns=function(n,g){return Object.prototype.hasOwnProperty.call(n,g)};
$jscomp.assign="function"==typeof Object.assign?Object.assign:function(n,g){for(var q=1;q<arguments.length;q++){var t=arguments[q];if(t)for(var w in t)$jscomp.owns(t,w)&&(n[w]=t[w])}return n};$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(n,g,q){n!=Array.prototype&&n!=Object.prototype&&(n[g]=q.value)};$jscomp.getGlobal=function(n){return"undefined"!=typeof window&&window===n?n:"undefined"!=typeof global&&null!=global?global:n};
$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(n,g,q,t){if(g){q=$jscomp.global;n=n.split(".");for(t=0;t<n.length-1;t++){var w=n[t];w in q||(q[w]={});q=q[w]}n=n[n.length-1];t=q[n];g=g(t);g!=t&&null!=g&&$jscomp.defineProperty(q,n,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Object.assign",function(n){return n||$jscomp.assign},"es6","es3");
(function(){function n(g,d){w[g]||(t[g]={exports:{},loaded:!1},w[g]=!0,0===g&&"function"===typeof require?require.main=t[0]:t[g].parent=t[d],q[g].call(this,t[g],t[g].exports),t[g].loaded=!0);return t[g].exports}function g(g){return require("path").resolve(__dirname+"/"+g+"/../")}var q={},t={},w={};q[0]=function(g,d){fs=require("fs");var u=n(1,0);d=require("commander");d.version("1.0").option("-s, --servicename <servicename>","servicename").option("-l, --list ","list system services").option("-t, --test ",
"test cipher").option("-i, --initoptions <initoptions>","application specific options see serviceconfigfile init.options").parse(process.argv);if(process.argv.slice(2).length)if(d.servicename){var q=d.servicename;d.initoptions&&console.log("initoptions="+d.initoptions);u.startsystemservice(q,JSON.parse(d.initoptions))}else{if(d.list)for(q in u=u.getsystemserviceconfig(),console.log(JSON.stringify(u,0,2)),u)console.log("service="+q+"\n  description="+u[q].description+"\n  url="+u[q].url+" security mode="+
u[q].security);d.test&&(require("crypto"),d=n(2,0),q=d.Cipher("whisper","hello world"),d=d.Decipher("whisper",q),console.log(d.toString("UTF8")))}else d.outputHelp();return g.exports};q[1]=function(q,d){function u(a,b,c){c=c.toLowerCase();var m=[];try{m=a.routes.filter(function(a,e){e=a.route;if("static"===a.type)l=e;else{var l=e.replace(/\/:[a-z0-9A-Z.%\-_,;:()*?@'!]+/g,"/[a-z0-9A-Z.%\\-_,;:()*?@'!]+");"*"==l?l=".*":("/"==b[b.length-1]&&"/"!=e[e.length-1]&&(l+="\\/"),"/"!=b[b.length-1]&&"/"==e[e.length-
1]&&(b+="/"));l+="$"}if(0==b.search(new RegExp(l,"g"))&&(a.type.toLowerCase()==c||"static"==a.type.toLowerCase()&&"get"===c))throw m.push(a),m;})}catch(P){if("array"==typeof P)return P}return m[0]}function t(a,b,c){return a.routes.filter(function(a){return a.route==b&&a.type==c})[0]}function U(a,b,c){b&&(l=b);this.all("*",function(a,b,c){l.corsurl&&(b.header("Access-Control-Allow-Origin",l.corsurl),b.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE,OPTIONS"),b.header("Access-Control-Allow-Credentials",
"true"),b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Key, Authorization"));b.header("X-Powered-By","cirruswave");c()});if(l.usecookies){var m=l.cookiesecret?h(l.cookiesecret):h();this.use(m)}this.use(e.json());this.use(e.urlencoded({extended:!0}));this.use(k.static(v.join(g("index.js"),"templates")));this.use("/service",k.static(v.join(g("index.js"),"templates")));this.use("/samples",k.static(v.join(g("index.js"),"templates")));this.use("/dashboard",k.static(v.join(g("index.js"),
"templates")));this.use("/css",k.static(v.join(g("index.js"),"templates")));this.use("/images",k.static(v.join(g("index.js"),"templates")));this.use("/css/bootstrap.css.map/",k.static(v.join(g("index.js"),"templates")));this.use("/documentation",function(a,b){A(a,b)});this.use("/test",function(a,b){C(a,b,!0,null,null)});this.use("/testhttp",function(a,b){C(a,b,!1,null,null)});this.get("/routelist/:servicename",function(a,c){L(a,c,b)});this.use("/servicelist",function(a,c){J(a,c,b)});this.use("/editservices",
function(a,b){a=y.readFileSync(g("index.js")+"/templates/services.html","utf8");var c="",m="",e=!1;l.services.hasOwnProperty("keymgr")&&(e=!0);if(!e){var h="";e||(h="System services can not be edited thorugh this interface but they can be viewed in documentation.  To see the list of services, please run the keymgr service. ");c+="<li><a class='scrollto' href='#about'>about</a></li>";e="<pre>"+JSON.stringify(l.about,0,2)+"</pre>";var x=l.about?'about <a href="/editabout" title="edit \'about\' section" class="btn btn-link btn-sm"><span class="glyphicon glyphicon-pencil"></span></a>':
'about <a href="/createabout" title="create \'about\' section" class="btn btn-link btn-sm"><span class="glyphicon glyphicon-plus"></span></a>';m+='<section id="REPLserviceid" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",e).replace(/REPLservicename/g,x).replace(/REPLserviceid/g,"about");for(var f in l.services)e="",x=l.services[f],c+="<li><a class='scrollto' href='#"+f+"'>"+f+"</a></li>",
e+="<pre>"+JSON.stringify(x,0,2)+"</pre>",x=f+' <a href="/editservice?service='+f+'" title="edit \''+f+'\' section" class="btn btn-link btn-sm">',x+='<span class="glyphicon glyphicon-pencil"></span></a>',m+='<section id="REPLserviceid" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",e).replace(/REPLservicename/g,x).replace(/REPLserviceid/g,f);x='<a href="/createservice" title="create new service" class1="btn btn-link btn-sm"><span class="glyphicon glyphicon-plus"></span></a>';
c+="<li>"+x+"</li>";m+='<section id="REPLserviceid" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent","").replace(/REPLservicename/g,x).replace(/REPLserviceid/g,"Create New Service");a=a.replace("REPLNotice",h).replace("REPLservicelist",c).replace("REPLsectioncontent",m);a=B(a);b.send(a)}});this.use("/editabout",function(a,b){w(a,b,!1)});this.use("/editservice",function(a,b){w(a,b,!0)});
this.get("/routeinfo/:servicename",function(a,c){M(a,c,b)});this.use("/service/:servicename",function(a,c){I(a.params.servicename,a,c,b)});this.use("/samples/:servicename",function(a,c){K(a.params.servicename,a,c,b)});this.use("/testhttpapi",function(a,b){a:{var c={},m={req:a,res:b,fService:!1};if(a.body.method){a.body.method=a.body.method.toLowerCase();var e={security:"accesskey"};e.Authorization=a.body.auth;e.Date=a.body.date;switch(a.body.method){case "post":try{""!==a.body.payload&&(c=JSON.parse(a.body.payload))}catch(R){b.json({error:"payload is not proper json"});
break a}p.PostPutHttp("POST",e,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),D,m);break;case "put":try{c=JSON.parse(a.body.payload)}catch(R){b.json({error:"payload is not proper json"});break a}p.PostPutHttp("PUT",null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),D,m);break;case "get":p.GetHttpProper(e,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),D,m);break;case "delete":p.DeleteHttp(e,null,a.body.protocol,
a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),D,m)}}else b.send("error - method missing in the form")}});this.use("/testapi",function(a,c){"save"===a.body.action?c.json("Saved"):E(a,c,b,D,{req:a,res:c,fService:!0})});this.validatesecurekey(a,b);this.get("/logoutbasic",function(b,c){switch(l.services[a].security){case "basic":c.status(401).send("Logged out");break;default:c.status(404).send("logoutbasic command available only when security is basic")}});this.get("/",function(a,b){A(a,
b);next()});var x=this;this.get("/log/:level/:message",function(a,b){var c=p.ValidateSchemaErrorObject(a.params,{type:"object",required:["level","message"],properties:{level:{description:"level buckets",type:"string","enum":["info","trace","error","warn","debug"]},message:{description:"message text",type:"string",minLength:1,maxLength:2048}}});c?(x.LogObject("error",a,"schema error "+c,"Logger"),b.status(422).send(c)):(x.LogObject(a.params.level,a,a.params.message,"Logger"),b.status(200).send("OK"))});
m=l.services[a];this.BodyValidate(a,m.configfilepath);if(m.init&&"object"==typeof m.init&&m.init.class&&m.init.function){var N=require(v.resolve(g("index.js"),m.init.class)),f=null;c&&(f=c);m.init.options&&!f&&(f=m.init.options);if(m.init.optionschema&&(c=p.ValidateSchemaErrorObject(f,m.init.optionschema))){console.error("options do not conform to schema error="+c);return}N[m.init.function](f)}}function F(a,b){var c=g("index.js");G&&(c=G);var e=require(v.resolve(c,b)),m=this;this.post("/*",function(b,
c,l){m.LogObject("event",b,"Entering",a);var h=u(e,b.path,b.method);h?p.ParamValidate(b,c,h,e.definitions)&&p.BodyValidate(b,c,h,e.definitions)&&l():c.status(422).json({errors:"path="+b.path+" not found"})});this.put("/*",function(b,c,l){m.LogObject("event",b,"Entering",a);var h=u(e,b.path,b.method);h?p.ParamValidate(b,c,h,e.definitions)&&p.BodyValidate(b,c,h,e.definitions)&&l():c.status(422).json({errors:"path="+b.path+" not found"})});this.get("/*",function(b,c,l){m.LogObject("event",b,"Entering",
a);var h=u(e,b.path,b.method);h?p.ParamValidate(b,c,h,e.definitions)&&l():(m.LogObject("error",b,"no route found",a),c.status(422).json({errors:"path="+b.path+" not found"}))});this.delete("/*",function(b,c,l){m.LogObject("event",b,"Entering",a);var h=u(e,b.path,b.method);h?p.ParamValidate(b,c,h,e.definitions)&&l():c.status(422).json({errors:"path="+b.path+" not found"})});this.use(function(b,c,l){var h=c.send;c.send=function(l){var x=u(e,b.path,b.method),f=null;x&&x.responseschema&&(e.definitions&&
(x.responseschema.definitions=x.responseschema.definitions?Object.assign(x.responseschema.definitions,definitions):e.definitions),f=p.ValidateSchemaErrorObject(JSON.parse(l),x.responseschema));f&&(arguments[0]=JSON.stringify({error:f}),c.status(422));h.apply(c,arguments);m.LogObject("event",b,"Leaving",a)};l()})}function r(a,b,c){try{JSON.parse(c)}catch(aa){}200!=b?a.res.status(b).json(JSON.stringify(c)):a.next()}function z(a,b){this.use(function(b,c,e){switch(l.services[a].security){case "appkey":var m=
p.ServiceKeyName(a);if(!b.headers[m]||b.headers[m]!==l.services[a].key){b="invalid key to service="+m+" value="+b.headers[m];c.status(401).send(b);return}break;case "basic":m=null;b.headers&&(m=b.headers.authorization);if(!m){c.set("WWW-Authenticate",'Basic realm="User Visible Realm"');c.status(401).send("Authorization header missing");return}m=m.search(/basic /i);if(0!=m)return c.set("WWW-Authenticate",'Basic realm="User Visible Realm"'),Error(401,"basic authorization header needs to start with [basic base64 encoded acckey:clientkey]");
case "accesskey":if("accesskey"===l.services[a].security&&(m=null,b.headers&&(m=b.headers.authorization),m||c.status(401).send("Authorization header missing"),m=m.search(/hmac /i),0!=m))return Error(401,"hmac authorization header needs hmac encoded string");e={req:b,res:c,next:e};m={body:{}};m.body.payload=JSON.stringify({headers:b.headers,servicename:a});m.body.service="keymgr";m.body.method="post";m.body.routena="/grants/check";E(m,c,null,r,e);return}e()})}function H(){return l.services.hasOwnProperty("keymgr")?
!0:!1}function B(a){if(H())var b="/images/favicon.png",c="/imagesfavicon.png",e="https://www.cirruswave.com",m="cirrus";else c=b="/images/sample.png",e="/documentation",m="SampleService";l.about&&(l.about.faviconurl&&(b=l.about.faviconurl),l.about.imageurl&&(c=l.about.imageurl),l.about.url&&(e=l.about.url),l.about.name&&(m=l.about.name));a=a.replace(/REPLFavIcon/g,b);return a.replace("REPLLogo",'<h1 style="background-color:#d8b2d880"><a href="'+e+'"><img src="'+c+'" style="height:32px" />'+m+"</a></h1>")}
function A(a,b){a=y.readFileSync(g("index.js")+"/templates/documentation.html","utf8");b.set("Content-Type","text/html");a=B(a);b.send(a)}function C(a,b,c,e,h){var m=c?y.readFileSync(g("index.js")+"/templates/testform.html","utf8"):y.readFileSync(g("index.js")+"/templates/testrest.html","utf8");b.set("Content-Type","text/html");if(c){c="";var f=null;h&&(f=a.body.service);var x=H();for(d in l.services){var k=l.services[d];if(x){var p=v.resolve(g("index.js"),k.configfilepath);if(!y.existsSync(p)){this.LogObject("error",
a,"service="+d+" not deployed configpath="+p+" does not exist",d);continue}}c+="<option class='btn-info form-control' ";f==d&&(c+="selected ");c+="value="+k.security+"@@@"+d;c+=">"+d+"</option>"}m=m.replace(/REPLservicelist/g,c);var d="";a.body.route&&(d="<input id='rname' type='text' style='display:none' value='"+a.body.route+"' /><input id='rtype' type='text' style='display:none' value='"+a.body.method+"' /><input id='rpayload' type='text' style='display:none' value='"+a.body.payload+"' />");m=
m.replace(/REPLRoute/,d)}h?(a='<h2 class="title">Response</h2>',200!=e&&(a+='<h6 style="color:#800000">status='+e+"</h4>"),h=a+"<pre>"+h+"</pre>"):h="";m=m.replace("REPLExtra",h);m=B(m);b.send(m)}function w(a,b,c){var e=null,m=y.readFileSync(g("index.js")+"/templates/edit.html","utf8");b.set("Content-Type","text/html");if(c){c="";var h=null;e&&(h=a.body.service);var f=H();for(p in l.services){var k=l.services[p];if(f){var d=v.resolve(g("index.js"),k.configfilepath);if(!y.existsSync(d)){this.LogObject("error",
a,"service="+p+" not deployed configpath="+d+" does not exist",p);continue}}c+="<option class='btn-info form-control' ";h==p&&(c+="selected ");c+="value="+k.security+"@@@"+p;c+=">"+p+"</option>"}var p='<div id="foodiv" class="form-group row "><label style="vertical-align: middle;" class="col-sm-2">foo</label><div class="col-sm-10"><input type="text" id="foo" name="foo" title="foo" class="form-control"  placeholder="appkey - required only in production mode" aria-describedby="basic-addon2"></div></div>';
m=m.replace(/REPLservicelist/g,c);c="";a.body.route&&(c="<input id='rname' type='text' style='display:none' value='"+a.body.route+"' /><input id='rtype' type='text' style='display:none' value='"+a.body.method+"' /><input id='rpayload' type='text' style='display:none' value='"+a.body.payload+"' />");m=m.replace(/REPLRoute/,c).replace(/REPLForm/,p)}e?(a='<h2 class="title">Response</h2>',200!=status&&(a+='<h6 style="color:#800000">status='+status+"</h4>"),e=a+"<pre>"+e+"</pre>"):e="";m=m.replace("REPLExtra",
e);m=B(m);b.send(m)}function L(a,b,c){if(a.params.servicename)if(c=l.services[a.params.servicename])if(c&&c.configfilepath){var e=g("index.js");G&&(e=G);c=v.resolve(e,c.configfilepath);y.existsSync(c)?(a=require(c),b.json(a.routes)):b.status(404).send("service="+a.params.servicename+" not deployed")}else c="servicename="+a.params.servicename+" not found",this.LogObject("error",a,c,a.params.servicename),b.status(404).send(c);else this.LogObject("error",a,"servicename="+a.params.servicename+" not found in serviceconfig.json",
a.params.servicename);else b.status(422).send("servicename is required")}function M(a,b,c){if(a.params.servicename)if(a.query.r)if(a.query.m)if(c=l.services[a.params.servicename]){var e=g("index.js");G&&(e=G);c=require(v.resolve(e,c.configfilepath));(a=t(c,a.query.r,a.query.m))||(a=c.routes[0]);a.configured?b.json(a):b.status(422).send("route not configured")}else c="servicename="+a.params.servicename+" not found in serviceconfig.json",this.LogObject("error",a,c,a.params.servicename),b.status(403).send(c);
else b.status(422).send("method is required");else b.status(422).send("routename is required");else b.status(422).send("servicename is required")}function D(a,b,c){try{var e=JSON.parse(c)}catch(P){e={data:c}}a.res.headerSent||C(a.req,a.res,a.fService,b,JSON.stringify(e,0,2))}function E(a,c,b,e,l){b&&"object"===typeof b?b=b.services[a.body.service]:(b=g("index.js")+"/deploy/lib/serviceconfig.json",b=p.GetServiceConfig(b,a.body.service));S&&S.dnsservicename&&"localhost"==b.hostname&&(b.hostname=a.body.service,
this.LogObject("trace",a,"ExecuteTestApp hostname="+b.hostname,"ExecuteTestApp"));var h={},m=null,f=null;switch(b.security){case "basic":case "accesskey":m={};m.security=b.security;m.nonce=W++;m.acckey=a.body.acckey;m.secret=a.body.secretna;break;case "appkey":f=a.body.appkey?p.MakeKeyServiceAndKeyValue(a.body.service,a.body.appkey):p.MakeKeyServiceAndKeyValue(a.body.service,b.key)}switch(a.body.method){case "post":try{""!==a.body.payload&&(h=JSON.parse(a.body.payload))}catch(V){c.json({error:"payload is not proper json"});
break}p.PostPutHttp("POST",m,f,b.protocol,b.hostname,a.body.routena,b.port,JSON.stringify(h),e,l);break;case "put":try{""!==a.body.payload&&(h=JSON.parse(a.body.payload))}catch(V){c.json({error:"payload is not proper json"});break}p.PostPutHttp("PUT",m,f,b.protocol,b.hostname,a.body.routena,b.port,JSON.stringify(h),e,l);break;case "static":case "get":p.GetHttpProper(m,f,b.protocol,b.hostname,a.body.routena,b.port,"",e,l);break;case "delete":p.DeleteHttp(m,f,b.protocol,b.hostname,a.body.routena,b.port,
"",e,l)}}function J(a,b){var c=y.readFileSync(g("index.js")+"/templates/services.html","utf8"),e="",h="",m=!1;l.services.hasOwnProperty("keymgr")&&(m=!0);var f="";m||(f="There are system services available. To see the list of services, please run the keymgr service. For an example of how to run keymgr system service, please see corresponding usage in runsampleservice.bash in examples directory.");for(var p in l.services){var k="",d=l.services[p];if(m){var r=v.resolve(g("index.js"),d.configfilepath);
if(!y.existsSync(r)){this.LogObject("error",a,"service="+p+" not deployed configpath="+r+" does not exist",p);continue}}e+="<li><a class='scrollto' href='#"+p+"'>"+p+"</a></li>";k+="<p><b>"+d.description+"</b></p><br/>";k+="<p><b>Documentation: </b><a class='btn-cirrus' href=/service/"+p+">"+p+"</a></p>";if(d.pathsamples){var N=null;r=v.resolve(g("index.js"),d.pathsamples+"/examples.json");try{N=require(r)}catch(R){this.LogObject("error",a,"samples for "+r+" do not exist diname="+g("index.js"),p)}N&&
(k+="<p><b>Examples:</b><a class='btn-cirrus' href=/samples/"+p+">"+p+"</a></p>")}k+="<br/>";m&&(k+="For an example of how to run "+p+" system service, please see corresponding usage in runsampleservice.bash in examples directory.",k+="<br/>",k+="<p><b>Launch command: </b>node ../cirruswave/cirruswaverouteservice.js -s "+p,d.init&&d.init.optionschema&&(k+=" -i &lt;option json&gt;</p>",k+="<p>&lt;option json&gt; needs to conform to this schema:</p>",k+="<pre>"+JSON.stringify(d.init.optionschema,0,
2)+"</pre>",d.init.options&&(k+="<p>default &lt;option json&gt;:</p>",k+="<pre>"+JSON.stringify(d.init.options,0,2)+"</pre>")));h+='<section id="REPLservicename" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",k).replace(/REPLservicename/g,p)}c=c.replace("REPLNotice",f).replace("REPLservicelist",e).replace("REPLsectioncontent",h);c=B(c);b.send(c)}function I(a,b,c,e){if(a){var h=l.services[a];
if(h)if(h.configfilepath){e=y.readFileSync(g("index.js")+"/templates/routes.html","utf8");e=e.replace("REPLservicedescription",h.description);var f="",m="",p=g("index.js");G&&(p=G);try{var k=require(v.resolve(p,h.configfilepath))}catch(Q){this.LogObject("error",b,Q,a);c.status(422).send(Q);return}for(var d in k.routes)if(b=k.routes[d],b.configured){h="";h+="<h6><pre>"+b.description+"</pre></h6>";h+="<h6>method="+b.type+"</h6>";b.paramschema&&(h+="<br><pre>parameter="+JSON.stringify(b.paramschema,
0,2)+"</pre>");b.bodyschema&&(h+="<br><pre>payload="+JSON.stringify(b.bodyschema,0,2)+"</pre>");b.responseschema&&(h+="<br><pre>returnValue="+JSON.stringify(b.responseschema,0,2)+"</pre>");if(b.examples&&Array.isArray(b.examples)&&0<b.examples.length){h+="<br><h6>examples:</h6><pre>";for(var r in b.examples)0<r&&(h+="<br>"),b.examples[r].param&&(h+="params="+X(b.examples[r].param)),b.examples[r].payload&&(h+="payload="+JSON.stringify(b.examples[r].payload,0,2));h+="</pre>"}f+="<li><a class='scrollto' href='#"+
b.route+"'>"+b.route+"</a></li>";m+='<section id="REPLroutename" class="doc-section"><h2 class="section-title">REPLroutename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",h).replace(/REPLroutename/g,b.route)}e=e.replace(/REPLservice/g,a).replace("REPLroutelist",f).replace("REPLsectioncontent",m).replace(/REPLHeader/,"Documentation for the service").replace(/REPLSectionHeader/g,"API Routes");e=B(e);c.send(e)}else a="servicename="+a+" has no configfilepath",
this.LogObject("trace",b,a,"RenderEditServices"),c.status(422).send(a);else a="servicename="+a+" not found in serviceconfig.json",this.LogObject("error",b,a,"RenderEditServices"),c.status(422).send(a)}else c.status(422).send("servicename is required")}function K(a,b,c){if(a){var e=l.services[a];if(!e)this.LogObject("error",b,"servicename "+a+" not found in serviceconfig.json",a);else if(e.pathsamples){var h=null,f=v.resolve(g("index.js"),e.pathsamples+"/examples.json");try{h=require(f)}catch(ba){this.LogObject("trace",
b,"samples for "+f+" do not exist","RenderEditServices")}b=y.readFileSync(g("index.js")+"/templates/routes.html","utf8");b=b.replace("REPLservicedescription",e.description);var m=f="";if(h)for(var p in h.Samples){var k=h.Samples[p],d="";d+="<h6><pre>"+k.description+"</pre></h6>";for(var r in k.code){var n=y.readFileSync(v.resolve(g("index.js"),e.pathsamples+"/"+k.code[r]),"utf8"),z="code";k.code[r].search(".sh")==k.code[r].length-3&&(z="bashcode");d=k.code[r].search(".html")==k.code[r].length-5?d+
("<div>"+n+"</div>"):d+("<pre class='"+z+"'>"+n+"</pre>")}f+="<li><a class='scrollto' href='#"+p+"'>"+p+"</a></li>";m+='<section id="REPLroutename" class="doc-section"><h2 class="section-title">REPLroutename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",d).replace(/REPLroutename/g,p)}b=b.replace(/REPLservice/g,a).replace("REPLroutelist",f).replace("REPLsectioncontent",m).replace(/REPLHeader/,"Sample code for the service").replace(/REPLSectionHeader/g,
"Examples");b=B(b);c.send(b)}}else c.status(422).send("servicename is required")}function a(a,b){this.startservice(a,null,null,b)}function b(a,b,c,e){var h=null,f=g("index.js");b&&(h=require(v.resolve(b,c)),require(v.resolve(b,h.services[a].configfilepath)),f=b);c||(c="./deploy/lib/serviceconfig.json");G=b;this.initialize(a,h,e);h&&(l=h);this.setuproutes(f,l.services[a].configfilepath);b=l.services[a];var k=b.port;c=v.resolve(f,c);b.key=p.EstablishKey(c,a);console.log("                                                           \ncirruwave image goes here \n                    CirrusWave                      \n");
var d=this;b.certPath?(c=v.resolve(f,"./"+b.certPath+".key"),f=v.resolve(f,"./"+b.certPath+".crt"),f={key:y.readFileSync(c),cert:y.readFileSync(f)},Y.createServer(f,this).listen(k,function(){d.LogObject("trace",null,"Securely listening on port "+k,a)})):this.listen(k,function(){d.LogObject("trace",null,"listening on port "+k,a)})}function c(a,b){b=require(v.resolve(a,b));for(var c in b.routes){var e=b.routes[c];if(e.configured){var h=v.resolve(a,e.routeclass);"static"===e.type?this.use(e.route,k.static(h)):
(h=require(h),this[e.type](e.route,h[e.routefunction]))}}}function f(a,b,c,e){var h={};h.level=a;null!=b&&(h.url=b.originalUrl,h.method=b.method,h.useragent=b.headers["user-agent"],h.host=b.host);this.logger[a](c,h,{label:e})}var k=require("express"),e=require("body-parser"),h=require("cookie-parser"),l=require("./deploy/lib/serviceconfig.json"),p=n(2,1),Y=require("https"),y=require("fs"),v=require("path");require("util");n(3,1);var X=require("htmlencode").htmlEncode,G=null;try{var T=v.resolve(g("index.js"),
"./lib/deploy.json");console.log(T);var Z=y.readFileSync(T,"UTF8"),S=JSON.parse(Z)}catch(m){"ENOENT"!=m.code&&console.log(m.code+" - "+m.message)}var W=17986;d=function(){var e=k.call(this)||this;var h=require("winston"),l=h.format.printf(function(a){return a.timestamp+" ["+a.label+"]  "+a.level+": "+a.message}),p=[];p.push(new h.transports.Console);e.logger=h.createLogger({levels:{trace:5,event:4,debug:3,info:2,warn:1,error:0},transports:p,level:"trace",colorize:!0,prettyPrint:!0,silent:!1,format:h.format.combine(h.format.label({label:"right meow!"}),
h.format.splat(),h.format.timestamp(),l)});e.LogObject=f;e.initialize=U;e.startservice=b;e.startsystemservice=a;e.setuproutes=c;e.validatesecurekey=z;e.BodyValidate=F;return e};$jscomp.inherits(d,k);d=new d;q.exports=d;return q.exports};q[2]=function(q,d){function u(a,b){a=A.createHmac("sha256",a);a.update(b);return a.digest("hex")}function t(a,b){var c=n(3,2);if(a.secret&&a.acckey){if("accesskey"===a.security){var f=new Date,k=a.acckey+":"+a.nonce;b.Authorization="hmac "+k+":"+c.Sign(a.secret,k+
":"+f);b.Date=f;return}if("basic"===a.security){c=Buffer.from(a.acckey+":"+a.secret).toString("base64");b.Authorization="basic "+c;return}}a.Authorization?(b.Authorization=a.Authorization,c=b.Authorization.indexOf("hmac "),0!=c?(c=b.Authorization.search(/basic /i),0!==c&&console.log("badly formed authorization string - needs to start with hmac")):(c=b.Authorization.slice(c+5),c.split(":"),b.Date=a.Date)):console.log("missing authorization string")}function C(a){if(!a)return null;var b="",c;for(c in a)"object"===
typeof a[c]?(""!=b&&(b+="&"),b+=c+"="+JSON.stringify(a[c])):"array"!==typeof a[c]&&(""!=b&&(b+="&"),b+=c+"="+a[c]);return b}var F=require("http"),r=require("https"),z=require("fs"),H=require("path"),B=require("querystring"),A=require("crypto"),w=require("jsonschema").Validator;d.Cipher=function(a,b){var c=A.randomBytes(16).toString("hex").slice(0,16),f=A.createHash("sha256").update(a).digest("hex");f=f.slice(0,32);b=A.createCipheriv("aes-256-ctr",f,c).update(b).toString("hex");a=u(a,b);return c+":::"+
b+":::"+a};d.Decipher=function(a,b){var c=b.split(":::");b=c[0];var f=c[2],k=u(a,c[1]);if(f!=k)return null;c=new Buffer(c[1],"hex");a=A.createHash("sha256").update(a).digest("hex");a=a.slice(0,32);return A.createDecipheriv("aes-256-ctr",a,b).update(c)};d.ValidateSchemaErrorObject=function(a,b){a=(new w).validate(a,b);if(a.errors.length){b="";for(var c in a.errors)b+=a.errors[c].stack+" ";return b}return null};d.ValidateSchema=function(a,b,c,f){return(a=this.ValidateSchemaErrorObject(a,b))?(f.status(422).json({errors:a}),
!1):!0};d.BodyValidate=function(a,b,c,f){return c&&c.bodyschema?(f&&(c.bodyschema.definitions=c.bodyschema.definitions?Object.assign(c.bodyschema.definitions,f):f),this.ValidateSchema(a.body,c.bodyschema,a,b)):!0};d.ParamValidate=function(a,b,c,f){if(c&&c.paramschema){var k=a.params[0],e=c.route;"/"==e.slice(0,1)&&(e=e.slice(1));"/"==k.slice(0,1)&&(k=k.slice(1));"/"==e.slice(-1)&&(e=e.slice(0,-1));"/"==k.slice(-1)&&(k=k.slice(0,-1));for(var h={};""!=e;){var l=!1;":"==e.slice(0,1)&&(l=!0,e=e.slice(1));
var p=e.search("/"),d=k.search("/");if(0<=p){var r=e.slice(0,p);e=e.slice(p+1);var g=k.slice(0,d);k=k.slice(d+1)}else r=e.slice(0),e="",g=k.slice(0),k="";l&&(l=Number(g),isNaN(l)?h[r]=g:h[r]=l)}f&&(c.paramschema.definitions=c.paramschema.definitions?Object.assign(c.paramschema.definitions,f):f);f=a.query;for(p in f)isNaN(f[p])||(f[p]=Number(f[p]));h=Object.assign({},h,f);return this.ValidateSchema(h,c.paramschema,a,b)}return!0};d.deep_value=function(a,b){b=b.split(".");for(var c in b)a=a[b[c]];return a};
var O=require("os");d.GetIPFromService=function(a){var b=O.networkInterfaces(),c=null;a.networkname&&(c=a.networkname);a=null;for(var f in b){for(var k in b[f]){var e=b[f][k];"IPv4"!==e.family||e.internal||(a=e.address)}if(f==c)break}return a};d.getFunctionsOfObject=function(a){return Object.getOwnPropertyNames(a).filter(function(b){return"function"==typeof a[b]})};d.MakeDir=function(a){var b=require("child_process").exec;b("mkdir  "+a)};d.WriteFile=function(a,b){try{return z.writeFileSync(a,b,"utf8"),
!0}catch(c){return!1}};d.FormatYYYYMMDD=function(a){return a.getUTCFullYear()+"-"+("0"+(a.getUTCMonth()+1)).slice(-2)+"-"+("0"+a.getUTCDate()).slice(-2)};d.FormatYYYYMMDDHHMMSS=function(a){return this.FormatYYYYMMDD(a)+"-"+("0"+a.getUTCHours()).slice(-2)+"-"+("0"+a.getUTCMinutes()).slice(-2)+"-"+("0"+a.getUTCSeconds()).slice(-2)};d.FormatYYYYMMDDHHMMSSColon=function(a){return this.FormatYYYYMMDD(a)+"T"+("0"+a.getUTCHours()).slice(-2)+":"+("0"+a.getUTCMinutes()).slice(-2)+":"+("0"+a.getUTCSeconds()).slice(-2)};
d.Median=function(a){a.sort(function(a,b){return a-b});var b=a.length,c=Math.floor(b/2),f;1===b%2?f=a[c]:f=(a[c-1]+a[c])/2;return f};d.LowPassFilter=function(a,b,c){if(.1<Math.abs(b)){var f=(b-a)/a;f>c?b=a*(1+c):f<c&&(b=a*(1-c))}return b};d.PostPutHttp=function(a,b,c,f,k,e,h,l,p,d){var g={"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":l.length};c&&(g[c.keyName]=c.keyValue);if(b&&"object"===typeof b){if("accesskey"===b.security||"basic"===
b.security)t(b,g),b=null;b=null}a={hostname:k,port:h,path:e,method:a,headers:g,json:!0};b&&(a.auth=b);b=F;if("https"==f||"https:"==f)a.rejectUnauthorized=!1,b=r;f=b.request(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&(console.log("Error statusCode="+a.statusCode),b&&console.log("data="+JSON.stringify(b)));p&&p(d,a.statusCode,b)})});f.on("error",function(a){console.log("problem with request: "+a.message);p&&p(d,500,a)});f.write(l);
f.end()};d.PostHttpAuth=function(a,b,c,f,k,e,h,l,p){this.PostPutHttp("POST",a,b,c,f,k,e,h,l,p)};d.PostHttp=function(a,b,c,f,k,e,h,l){this.PostPutHttp("POST",null,a,b,c,f,k,e,h,l)};d.PutHttp=function(a,b,c,f,k,e,h,l){this.PostPutHttp("PUT",null,a,b,c,f,k,e,h,l)};d.GetHttpAuth=function(a,b,c,f,k){a=F.request({hostname:a,port:c,path:b+"/"+f,method:"GET",headers:{"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":f.length},json:!0},function(a){var b=
"";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);k(a.statusCode,b)})});a.on("error",function(a){console.log("problem with request: "+a.message)});a.end()};d.GetDeleteHttp=function(a,b,c,f,k,e,h,l,p,d){var g={"User-Agent":"app-bt/0.0.1","Cache-Control":"no-cache"};c&&(g[c.keyName]=c.keyValue);if(b&&"object"===typeof b){if("accesskey"===b.security||"basic"===b.security)t(b,g),b=null;b=null}l&&(l=B.escape(l),
e=e+"/?"+l);a={hostname:k,port:h,path:e,method:a,headers:g,json:!0};b&&(a.auth=b);b=F;if("https"==f||"https:"==f)a.rejectUnauthorized=!1,b=r;f=b.request(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);p(d,a.statusCode,b)})});f.on("error",function(a){console.log("problem with request: "+a.message)});f.end()};d.GetHttpProper=function(a,b,c,f,k,e,h,l,p){this.GetDeleteHttp("GET",a,b,c,f,
k,e,h,l,p)};d.DeleteHttp=function(a,b,c,f,k,e,h,l,p){this.GetDeleteHttp("DELETE",a,b,c,f,k,e,h,l,p)};var L=0,M=require("url");try{var D=H.resolve(g("cirruswaveutil.js"),"./lib/deploy.json"),E=z.readFileSync(D,"UTF8"),J=JSON.parse(E)}catch(a){"ENOENT"!=a.code&&console.log(a.code+" - "+a.message)}d.RestTaskCall=function(a,b,c){var f=!1,k={};a.payload&&console.log("\t\tpayload ="+JSON.stringify(a.payload));var e=null;if(a.service&&a.servicepath){if(a.sysservice){if(!a.serviceconfig){k="Parameter error: Task="+
a.name+" does not contain serviceconfig";console.error(k);b(c,404,JSON.stringify(k));return}var h=this.GetServiceConfig(a.serviceconfig,a.service)}else{if(!a.appserviceconfig){k="Parameter error: Task="+a.name+" does not contain appserviceconfig";console.error(k);b(c,404,JSON.stringify(k));return}h=this.GetServiceConfig(a.appserviceconfig,a.service);if(!h){if(!a.serviceconfig){k="Parameter error: Task="+a.name+" does not contain serviceconfig";console.error(k);b(c,404,JSON.stringify(k));return}h=
this.GetServiceConfig(a.serviceconfig,a.service)}}if(!(h&&"object"==typeof h&&h.hasOwnProperty("protocol")&&h.hasOwnProperty("hostname")&&h.hasOwnProperty("port"))){k="Parameter error: Task="+a.name+" has unrecognized service="+a.service+" sc="+JSON.stringify(h);console.error(k);b(c,404,JSON.stringify(k));return}J&&J.dnsservicename&&"localhost"==h.hostname&&(h.hostname=a.service);f=!0;k.protocol=h.protocol;k.hostname=h.hostname;k.port=h.port;switch(h.security){case "basic":case "accesskey":e={};e.security=
h.security;e.nonce=L++;e.acckey=a.acckey;e.secret=a.secretna;break;case "appkey":k.key=a.appkey?this.MakeKeyServiceAndKeyValue(a.service,a.appkey):this.MakeKeyServiceAndKeyValue(a.service,h.key)}k.pathname=a.servicepath;0!=k.pathname.search("/")&&(k.pathname="/"+k.pathname)}if(a.url||f)switch(f=null,a.payload&&(f=a.payload),a.url&&(k=M.parse(a.url),k.key=null),a.method){case "POST":a="";f&&(a=JSON.stringify(f));this.PostPutHttp("POST",e,k.key,k.protocol,k.hostname,k.pathname,k.port,a,b,c);break;case "PUT":a=
"";f&&(a=JSON.stringify(f));this.PostPutHttp("PUT",e,k.key,k.protocol,k.hostname,k.pathname,k.port,a,b,c);break;case "GET":a="";f&&(a=C(f));this.GetHttpProper(e,k.key,k.protocol,k.hostname,k.pathname,k.port,a,b,c);break;case "DELETE":a="";f&&(a=C(f));this.DeleteHttp(e,k.key,k.protocol,k.hostname,k.pathname,k.port,a,b,c);break;default:k=a.hasOwnProperty("name")?"Parameter error: Task="+a.name+" has unrecognized method="+a.method:"Parameter error: unrecognized method="+a.method,console.error(k),b(c,
404,{error:k})}else a.func?(a.payload&&JSON.parse(JSON.stringify(a.payload)),k=eval("this.to."+a.func+"(payload)"),b(c,200,k)):b(c,200,{})};d.ServiceKeyName=function(a){return a+"-api-key"};d.MakeKeyServiceAndKeyValue=function(a,b){if(!b)return null;var c={};c.keyName=this.ServiceKeyName(a);c.keyValue=b;return c};d.EstablishKey=function(a,b){var c=z.readFileSync(a,"utf8");c=JSON.parse(c);var f=c.services;if(!f||!f[b]||"appkey"!==f[b].security)return null;f[b].key||(f[b].key=this.GenerateKeyFromDate((new Date).toString()),
z.writeFileSync(a,JSON.stringify(c,0,2),"UTF8"));return f[b].key};d.GenerateKeyFromDate=function(a){return A.createHash("md5").update(a).digest("hex")};d.GetServiceConfig=function(a,b){var c=z.readFileSync(a,"utf8");c=JSON.parse(c);if(!c)return null;var f=c.services;if(!f||!f[b])return null;c=f[b];f[b].security||(f[b].security="nokey",z.writeFileSync(a,JSON.stringify(c,0,2),"UTF8"));return f[b]};d.PriorityQueue=function(a){this._comparator=a||this.DEFAULT_COMPARATOR;this._elements=[];this.DEFAULT_COMPARATOR=
function(a,c){if("number"===typeof a&&"number"===typeof c)return a-c;a=a.toString();c=c.toString();return a==c?0:a>c?1:-1};d.PriorityQueue.isEmpty=function(){return 0===this.size()};this.peek=function(){if(this.isEmpty())throw Error("PriorityQueue is empty");return this._elements[0]};this.deq=function(){return this._elements.length?this._elements.shift():null};this.enq=function(a){a=this._elements.push(a);for(var b=a-1;0<b;){var f=b-1;if(0>=this._compare(b,f))break;this._swap(f,b);b=f}return a};this.size=
function(){return this._elements.length};this.getElement=function(a){return 0>a||a>=this.size()?null:this._elements[a]};this.getElements=function(a){return this._elements};this.forEach=function(a){return this._elements.forEach(a)};this._compare=function(a,c){return this._comparator(this._elements[a],this._elements[c])};this._swap=function(a,c){var b=this._elements[a];this._elements[a]=this._elements[c];this._elements[c]=b}};var I=require("cacheman");d.TtlCache=function(a,b,c){if(!a)return null;if(b||
c){var f={};b&&(f.ttl=b);c&&(f.engine=c);this.cache=new I(a,f)}else this.cache=new I(a);this.Set=function(a,b,c){this.cache.set(a,b,c)};this.Get=function(a,b){this.cache.get(a,b)}};var K=require("dgram");d.Udp=function(a,b,c,f){this.server=K.createSocket("udp4");a||b?(this.server.bind({address:c,port:f}),this.server.on("listen",a),this.server.on("message",b),this.broadcastMode=!1):this.broadcastMode=!0;this.address=function(){return this.server.address().address};this.port=function(){return this.server.address().port};
this.broadcast=function(a,b,c){if(this.broadcastMode){var e=new Buffer(JSON.stringify(c));this.server.send(e,0,e.length,b,a,function(){console.log("Sent '"+e+"'")})}}};return q.exports};q[3]=function(q,d){function u(a,b){return{status:a,message:b}}function t(a,b){c.storage.Get(a,c.folderkeys,function(c,e){c?b(u(404,"acckey="+a+" "+c),null):b(null,e)})}function w(a,b){t(a,function(a,c){a?b(a,null):(a=JSON.parse(JSON.stringify(c)),delete a.secret,b(null,a))})}function F(a,b){c.storage.Get(a,c.folderids,
function(c,e){c?b(u(404,"client="+a+" "+c),null):b(null,e)})}function r(a,b,l){c.storage.Put(a,b,c.folderids,function(e,h){e?l(u(404,e),null):"file"===c.type?l(null,h):c.storage.Put(b.acckey,b,c.folderkeys,function(b,c){b&&H(a,!1,function(a,c){a?c(u(404,a),null):c(u(404,b),null)});l(null,c)})})}function z(a,b,c,f,d){F(a,function(e,h){var l={services:[]};e||(l=h);l.acckey=b;l.secret=c;l.clientid=a;for(var k in f)0>l.services.indexOf(f[k])&&l.services.push(f[k]);r(a,l,d)})}function H(a,b,l){F(a,function(e,
h){c.storage.Delete(a,c.folderids,function(a,e){a?l(a,null):"file"!==c.type&&b?c.storage.Delete(h.acckey,c.folderkeys,function(a,b){a?l(a,null):l(null,"OK")}):l(null,"OK")})})}function B(a,b){if(a=a.authorization)if(0!=a.search(/basic /i))b(u(403,"basic authorization header needs to start with basic"),null);else{a=a.slice(6);var c=Buffer.from(a,"base64").toString().split(":"),e=c[0];t(e,function(a,h){a?b(u(403,"acckey="+e+" not found"),null):c[1]===h.secret?b(null,h):b(u(403,"could not authenticate"),
null)})}else b(u("403","Authorization header missing"),null)}function A(a,b){var c=a.authorization;if(c)if(0!=c.search(/hmac /i))B(a,b);else{var e=c.slice(5).split(":"),h=e[0];t(h,function(c,f){if(c)b(u(403,"acckey="+h+" not found"),null);else{var l=a.date,d=e.splice(-1,1)[0];c=e.join(":");D(f.secret,c+(":"+l))==d?b(null,f):b(u(403,"could not authenticate"),null)}})}else b(u(403,"Authorization header missing"),null)}function C(a,b,c){var e=(new Date).valueOf(),h=Math.round(Math.random()*e),f=E.GenerateKeyFromDate(h.toString());
h=Math.round(Math.random()*e);e=E.GenerateKeyFromDate(h.toString());z(a,f,e,b,c)}function O(a){var b=E.GetServiceConfig(I,a);return b?b:b=E.GetServiceConfig(K,a)}function L(a,b,c){t(a,function(a,e){a?c(a,null):(a=O(b))?"accesskey"!==a.security&&"basic"!==a.security?c(u(403,"access is forbidden to service="+b),null):(b&&0>e.services.indexOf(b)&&e.services.push(b),r(e.clientid,e,c)):c(u(404,"No such service="+b),null)})}function M(a,b,c){t(a,function(a,e){a=O(b);"accesskey"!==a.security&&"basic"!==
a.security?c(u(403,"access is forbidden"),null):(a=e.services.indexOf(b),0>a?c(u(403,"no access to service="+b),null):(e.services.splice(a,1),r(e.clientid,e,c)))})}function D(a,b){a=J.createHmac("sha256",a);a.update(b);return a.digest("hex")}var E=n(2,3),J=require("crypto"),I=g("apikeymgr.js")+"/deploy/lib/serviceconfig.json",K=I,a=g("apikeymgr.js");require("fs");var b=require("path"),c=null,f=n(4,3),k=n(5,3);d.initialize=function(e){var h="./deploy/lib/aclconfig.json";if(e)switch(a=e.appdir,h=e.aclconfig,
K=b.resolve(a,e.appserviceconfig),c={type:"file"},e.persistence&&(c=e.persistence),c.folderkeys="pc-keyfolder/keys",c.folderids="pc-keyfolder/ids",c.type){case "file":c.storage=new k(e);break;case "s3":c.storage=new f({encseckey:e.secret,bucketName:c.bucketname,acckey:c.acckey,secretkey:c.secret,region:c.region})}e.aclconfpath=b.resolve(a,h)};d.Sign=function(a,b){return D(a,b)};d.RouteAllocateAccessKeys=function(a,b){C(a.params.clientid,[],function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c)})};
d.RouteGetClientFromClientid=function(a,b){F(a.params.clientid,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c)})};d.RouteGetClientFromAcckey=function(a,b){t(a.params.acckey,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c)})};d.RouteRevokeClient=function(a,b){H(a.params.clientid,!0,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json({data:"OK"})})};d.RouteGrantAccess=function(a,b){L(a.params.acckey,a.params.servicename,function(a,c){a?
b.status(a.status).json(a.message):b.status(200).json(c)})};d.RouteRevokeAccess=function(a,b){M(a.params.acckey,a.params.servicename,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c)})};d.RouteGetAccessServices=function(a,b){w(a.params.acckey,function(a,c){a?b.status(a.status).json(a.message):b.status(200).json(c.services)})};d.RouteGetAccessOneService=function(a,b){w(a.params.acckey,function(c,e){c?b.status(c.status).json(c.message):0>e.services.indexOf(a.params.servicename)?
b.status(404).json("access was never granted to client="+e.clientid+" for service="+servicename):b.status(200).json(a.params.servicename)})};d.RouteCheckAccessOneService=function(a,b){a.body.headers?A(a.body.headers,function(c,e){c?b.status(c.status).json(c.message):0>e.services.indexOf(a.body.servicename)?b.status(404).json("access was never granted to client="+o.clientid+" for service="+servicename):b.status(200).json({servicename:a.body.servicename})}):b.status(400).json("headers missing in the body of request")};
return q.exports};q[4]=function(g,d){var u=n(2,4),q=require("aws-sdk"),t=n(6,4);d=function(d){var r=t.call(this)||this;r.bucketName=d.bucketName;r.encseckey=d.encseckey;q.config.region=d.region;q.config.update({accessKeyId:d.acckey,secretAccessKey:d.secretkey});return r};$jscomp.inherits(d,t);d.prototype.Delete=function(d,r,g){(new q.S3({params:{Bucket:this.bucketName+"/"+r}})).deleteObject({Key:d},function(r,n){if(r)return console.log("Error in posting Content ["+r+"]"),!1;console.log("Successfully Deleted Key = "+
d);g&&g(null,"OK")}).on("httpUploadProgress",function(d){console.log(Math.round(d.loaded/d.total*100)+"% done")})};d.prototype.Get=function(d,r,g){var n=this;(new q.S3({params:{Bucket:this.bucketName+"/"+r}})).getObject({Key:d},function(d,r){if(d)return d="Error in getting Content ["+d+"]",console.log(d),g&&g(d,null),!1;d=r.Body.toString();n.encseckey&&(d=u.Decipher(n.encseckey,d),d=d.toString("UTF8"));console.log("Successfully Get Key = "+d);g&&g(null,JSON.parse(d))}).on("httpUploadProgress",function(d){console.log(Math.round(d.loaded/
d.total*100)+"% done")})};d.prototype.ListRecursive=function(d,g,n){var r=new q.S3({params:{Bucket:this.bucketName+"/"+d}});g={Bucket:this.bucketName,MaxKeys:100,ContinuationToken:g};null===d?g.Delimiter="/":g.Prefix="*"!=d?d:"";r.listObjectsV2(g,function(g,r){if(g)return strErr="Error in listing Contents ["+g+"]",console.log(strErr),n&&n(strErr,null),!1;n&&n(null,r);r.NextContinuationToken&&(console.log("continue="+r.NextContinuationToken),this.ListRecursive(d,r.NextContinuationToken))}).on("httpUploadProgress",
function(d){console.log(Math.round(d.loaded/d.total*100)+"% done")})};d.prototype.Listirectories=function(d){this.ListRecursive(null,null,d)};d.prototype.ListObjects=function(d,g){this.ListRecursive(d,null,g)};d.prototype.Put=function(d,g,n,t){n=new q.S3({params:{Bucket:this.bucketName+"/"+n}});var r=JSON.stringify(g);this.encseckey&&(r=u.Cipher(this.encseckey,r));n.putObject({Key:d,Body:r,ContentType:"text/plain; charset=utf-8"},function(d,r){if(d)return d="Error in posting Content ["+d+"]",console.log(d),
t&&t(d,null),!1;console.log("Successfully posted Content");t&&t(null,g)}).on("httpUploadProgress",function(d){console.log(Math.round(d.loaded/d.total*100)+"% done")})};g.exports=d;return g.exports};q[5]=function(g,d){var q=n(2,5),t=n(6,5),w=require("fs"),C=require("path");d=function(d){var g=t.call(this)||this;g.aclpath=d.aclconfpath;g.encseckey=d.secret;g.appdir=d.appdir;console.log(g.appdir);console.log(d.aclconfig);g.aclpath=C.resolve(g.appdir,d.aclconfig);g.acl=null;w.existsSync(g.aclpath)&&(g.acl=
g.ReadAclFromFile(g.aclpath));g.acl||(g.acl={},g.WriteAclToFile(g.aclpath));return g};$jscomp.inherits(d,t);d.prototype.CreateSignature=function(d){return crypto.createHash("sha256").update(d).digest("hex")};d.prototype.WriteAclToFile=function(d){d=JSON.stringify(this.acl);d=q.Cipher(this.encseckey,d);w.writeFileSync(this.aclpath,d)};d.prototype.ReadAclFromFile=function(d){d=w.readFileSync(this.aclpath,"utf8");d=q.Decipher(this.encseckey,d);if(!d)return null;d=d.toString("UTF8");return JSON.parse(d)};
d.prototype.Delete=function(d,g,n){var r=-1;if("pc-keyfolder/keys"===g){for(var q in this.acl)this.acl[q].acckey==d&&(r=q);if(-1===r){n("key "+d+" not found",null);return}}else r=d;delete this.acl[r];n&&n(null,"OK")};d.prototype.Listirectories=function(){};d.prototype.ListObjects=function(d){};d.prototype.Get=function(d,g,n){if("pc-keyfolder/keys"===g){for(var r in this.acl){var q=this.acl[r];if(q.acckey==d){q.clientid=r;n(null,q);return}}console.log("name="+d+" folder="+g);n("key "+d+" not found",
null)}else this.acl[d]?(this.acl[d].clientid=d,n(null,this.acl[d])):(console.log("name="+d+" folder="+g),n("client "+d+" does not exist",null))};d.prototype.Put=function(d,g,n,q){this.acl[d]||(this.acl[d]={services:[]});this.acl[d].acckey=g.acckey;this.acl[d].secret=g.secret;for(var r in g.services)0>this.acl[d].services.indexOf(g.services[r])&&this.acl[d].services.push(g.services[r]);this.WriteAclToFile(this.aclpath);q(null,this.acl[d])};g.exports=d;return g.exports};q[6]=function(g,d){g.exports=
function(){"storagedriver"===this.constructor.name&&(console.error("can not instantiate storage driver"),process.exit(1));var d=[];void 0===this.Get&&d.push("Get");void 0===this.Delete&&d.push("Delete");void 0===this.Listirectories&&d.push("Listirectories");void 0===this.ListObjects&&d.push("ListObjects");void 0===this.Put&&d.push("Put");d.length&&(console.error(d+" required on "+this.constructor.name+" class"),process.exit(1))};return g.exports};if("object"===typeof module)module.exports=n(0);else return n(0)})();
